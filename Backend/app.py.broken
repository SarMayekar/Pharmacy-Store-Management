import os
import mysql.connector
import datetime
import logging
        # Remove Row
        if "delrow" in request.form:
            del_idx = int(request.form['delrow'])
            items = [item for idx, item in enumerate(items) if idx != del_idx]
            rowcount = max(1, len(items))
            for item in items:
                item['sgst_percent'] = item.get('sgst_percent', '')
                item['cgst_percent'] = item.get('cgst_percent', '')
                item['gst_percent'] = str(float(item.get('sgst_percent', '0') or '0') + float(item.get('cgst_percent', '0') or '0'))
            return render_template('purchases.html', purchases_history=purchases_history, medicines=medicines,
                                  distributors=distributors, rowcount=rowcount, invoice_no=invoice_no,
                                  purchase_date=purchase_date, distributor_name=distributor_name,
                                  trade_type=trade_type, grand_total=grand_total, items=items,
                                  show_detail=show_detail, purchase_detail=purchase_detail,
                                  editing_purchase=editing_purchase, edit_purchase_id=edit_purchase_id, discount_percent=discount_percent,
                                  enumerate=enumerate)

        # Add Row
        if "addrow" in request.form:
            rowcount += 1
            items.append({})
            for item in items:
                item['sgst_percent'] = item.get('sgst_percent', '')
                item['cgst_percent'] = item.get('cgst_percent', '')
                item['gst_percent'] = str(float(item.get('sgst_percent', '0') or '0') + float(item.get('cgst_percent', '0') or '0'))
            return render_template('purchases.html', purchases_history=purchases_history, medicines=medicines,
                                  distributors=distributors, rowcount=rowcount, invoice_no=invoice_no,
                                  purchase_date=purchase_date, distributor_name=distributor_name,
                                  trade_type=trade_type, grand_total=grand_total, items=items,
                                  show_detail=show_detail, purchase_detail=purchase_detail,
                                  editing_purchase=editing_purchase, edit_purchase_id=edit_purchase_id, discount_percent=discount_percent,
                                  enumerate=enumerate)
def get_db_connection():
    return mysql.connector.connect(
        host='localhost',
        user='root',
        password='$@&Thak0',
        database='pharmacy_db',
        port=3306
    )

# ---------- ROOT/UTILITY ----------
@app.route('/')
def home():
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    selected_date = request.args.get('date', datetime.datetime.now().strftime('%Y-%m-%d'))
    # Total number of sales on selected date
    cursor.execute("SELECT COUNT(*) as total_sales FROM sales WHERE DATE(sale_datetime) = %s", (selected_date,))
    total_sales = cursor.fetchone()['total_sales']
    # Total items sold on selected date
    cursor.execute("""
        SELECT COALESCE(SUM(si.quantity), 0) as total_items
        FROM sales_items si
        JOIN sales s ON si.sale_id = s.id
        WHERE DATE(s.sale_datetime) = %s
    """, (selected_date,))
    total_items = cursor.fetchone()['total_items']
    # Total amount of sales on selected date
    cursor.execute("SELECT COALESCE(SUM(total_amount), 0) as total_amount FROM sales WHERE DATE(sale_datetime) = %s", (selected_date,))
    total_amount = cursor.fetchone()['total_amount']

    # Total number of purchases on selected date
    cursor.execute("SELECT COUNT(*) as total_purchases FROM purchases WHERE DATE(purchase_date) = %s", (selected_date,))
    total_purchases = cursor.fetchone()['total_purchases']
    # Total items purchased on selected date
    cursor.execute("""
        SELECT COALESCE(SUM(pi.quantity), 0) as total_items_purchased
        FROM purchase_items pi
        JOIN purchases p ON pi.purchase_id = p.id
        WHERE DATE(p.purchase_date) = %s
    """, (selected_date,))
    total_items_purchased = cursor.fetchone()['total_items_purchased']
    # Total amount of purchases on selected date
    cursor.execute("SELECT COALESCE(SUM(total_amount), 0) as total_amount_purchased FROM purchases WHERE DATE(purchase_date) = %s", (selected_date,))
    total_amount_purchased = cursor.fetchone()['total_amount_purchased']

    cursor.close()
    conn.close()
    return render_template('index.html',
                           total_sales=total_sales,
                           total_items=total_items,
                           total_amount=total_amount,
                           total_purchases=total_purchases,
                           total_items_purchased=total_items_purchased,
                           total_amount_purchased=total_amount_purchased,
                           selected_date=selected_date)

@app.route('/test-db')
def test_db():
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute('SHOW TABLES;')
    tables = cursor.fetchall()
    cursor.close()
    conn.close()
    return jsonify({'tables': [table[0] for table in tables]})

@app.route('/welcome', methods=['GET'])
def welcome():
    """
    Returns a welcome message
    """
    logger.info(f"Request received: {request.method} {request.path}")
    return jsonify({'message': 'Welcome to the Flask API Service!'})

# ---------- WEB INTERFACE ----------
@app.route('/sales', methods=['GET', 'POST'])
def sales_view():
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)

    # Fetch dropdown data
    cursor.execute("SELECT * FROM patients ORDER BY name;")
    patients = cursor.fetchall()
    cursor.execute("SELECT * FROM doctors ORDER BY name;")
    doctors = cursor.fetchall()
    cursor.execute("SELECT * FROM medicines ORDER BY name;")
    medicines = cursor.fetchall()

    # Fetch sales history with item counts
    cursor.execute("""
        SELECT s.id, s.invoice_no, s.sale_datetime, s.total_amount, p.name AS patient_name,
               COALESCE(cnt.item_qty, 0) AS item_count
          FROM sales s
          LEFT JOIN patients p ON s.patient_id = p.id
          LEFT JOIN (
            SELECT sale_id, SUM(quantity) AS item_qty
              FROM sales_items
             GROUP BY sale_id
          ) cnt ON cnt.sale_id = s.id
         ORDER BY s.sale_datetime DESC, s.id DESC
    """)
    sales_history = cursor.fetchall()

    def generate_invoice_no():
        today = datetime.datetime.now().strftime('%y%m%d')
        cursor.execute("SELECT MAX(CAST(RIGHT(invoice_no, 3) AS UNSIGNED)) as max_serial FROM sales WHERE LEFT(invoice_no, 6) = %s", (today,))
        data = cursor.fetchone()
        serial = (data['max_serial'] + 1) if data and data['max_serial'] else 1
        return f"{today}{serial:03d}"

    rowcount = 1
    invoice_no = generate_invoice_no()
    sale_date = datetime.datetime.now().strftime('%Y-%m-%d')
    patient_name = doctor_name = grand_total_mrp = grand_total_actual = savings_total = ''
    items = []
    bill_data = None
    show_bill = False

    if request.method == 'POST':
        rowcount = int(request.form.get('rowcount', 1))
        invoice_no = request.form.get('invoice_no') or generate_invoice_no()
        sale_date = request.form.get('sale_date', '') or datetime.datetime.now().strftime('%Y-%m-%d')
        patient_name = request.form.get('patient_name', '').strip()
        patient_contact = request.form.get('patient_contact', '').strip()
        doctor_name = request.form.get('doctor_name', '').strip()
        doctor_contact = request.form.get('doctor_contact', '').strip()
        grand_total_mrp = request.form.get('grand_total_mrp', '')
        grand_total_actual = request.form.get('grand_total_actual', '')
        savings_total = request.form.get('savings_total', '')

        if 'startedit_sale_id' in request.form:
            edit_id = int(request.form.get('startedit_sale_id'))
            cursor.execute("""
                SELECT s.*, p.name as patient_name, p.contact_number as patient_contact, d.name as doctor_name, d.contact_number as doctor_contact
                FROM sales s
                LEFT JOIN patients p ON s.patient_id = p.id
                LEFT JOIN doctors d ON s.doctor_id = d.id
                WHERE s.id = %s
            """, (edit_id,))
            editing_sale = cursor.fetchone()
            cursor.execute("""
                SELECT si.*, m.name as product, m.packing FROM sales_items si
                JOIN medicines m ON si.product_id = m.id
                WHERE si.sale_id = %s
            """, (edit_id,))
            item_list = cursor.fetchall()
            items = []
            for item in item_list:
                gst_percent = (item['sgst_percent'] or 0) + (item['cgst_percent'] or 0)
                items.append({
                    'product': item['product'],
                    'batch_no': item['batch_no'],
                    'expiry_date': item['expiry_date'],
                    'hsn_code': item['hsn_code'],
                    'mrp': item['mrp'],
                    'quantity': item['quantity'],
                    'rate': item['price'],
                    'gst_percent': gst_percent,
                    'discount_percent': item.get('discount_percent', ''),
                    'amount': item['amount'],
                    'packing': item.get('packing', ''),
                })
            rowcount = len(items) if items else 1
            return render_template('sales.html', patients=patients, doctors=doctors, medicines=medicines,
                                   rowcount=rowcount, invoice_no=editing_sale['invoice_no'], sale_date=editing_sale['sale_datetime'].strftime('%Y-%m-%d'),
                                   patient_name=editing_sale['patient_name'] or '', patient_contact=editing_sale['patient_contact'] or '',
                                   doctor_name=editing_sale['doctor_name'] or '', doctor_contact=editing_sale['doctor_contact'] or '',
                                   grand_total_mrp='', grand_total_actual=editing_sale['total_amount'], savings_total='',
                                   items=items, show_bill=False, bill_data=None, sales_history=sales_history,
                                   edit_sale_id=edit_id)

        if 'delrow' in request.form:
            del_idx = int(request.form['delrow'])
            items = [
                {
                    'product': request.form.get(f'items-{i}-product', ''),
                    'batch_no': request.form.get(f'items-{i}-batch_no', ''),
                    'expiry_date': request.form.get(f'items-{i}-expiry_date', ''),
                    'hsn_code': request.form.get(f'items-{i}-hsn_code', ''),
                    'mrp': request.form.get(f'items-{i}-mrp', ''),
                    'quantity': request.form.get(f'items-{i}-quantity', ''),
                    'rate': request.form.get(f'items-{i}-rate', ''),
                    'sgst_percent': request.form.get(f'items-{i}-sgst_percent', ''),
                    'cgst_percent': request.form.get(f'items-{i}-cgst_percent', ''),
                    'discount_percent': request.form.get(f'items-{i}-discount_percent', ''),
                    'amount': request.form.get(f'items-{i}-amount', ''),
                    'gst_percent': str(float(request.form.get(f'items-{i}-sgst_percent', '0') or '0') + float(request.form.get(f'items-{i}-cgst_percent', '0') or '0')),
                    'packing': request.form.get(f'items-{i}-packing', ''),
                }
                for i in range(rowcount) if i != del_idx
            ]
            rowcount = max(1, len(items))
            return render_template('sales.html', patients=patients, doctors=doctors, medicines=medicines,
                                   rowcount=rowcount, invoice_no=invoice_no, sale_date=sale_date,
                                   patient_name=patient_name, doctor_name=doctor_name,
                                   grand_total_mrp=grand_total_mrp, grand_total_actual=grand_total_actual,
                                   savings_total=savings_total, items=items,
                                   show_bill=show_bill, bill_data=bill_data, sales_history=sales_history, edit_sale_id=request.form.get('edit_sale_id'),
                                   enumerate=enumerate)

        if 'addrow' in request.form:
            items = [
                {
                    'product': request.form.get(f'items-{i}-product', ''),
                    'batch_no': request.form.get(f'items-{i}-batch_no', ''),
                    'expiry_date': request.form.get(f'items-{i}-expiry_date', ''),
                    'hsn_code': request.form.get(f'items-{i}-hsn_code', ''),
                    'mrp': request.form.get(f'items-{i}-mrp', ''),
                    'quantity': request.form.get(f'items-{i}-quantity', ''),
                    'rate': request.form.get(f'items-{i}-rate', ''),
                    'sgst_percent': request.form.get(f'items-{i}-sgst_percent', ''),
                    'cgst_percent': request.form.get(f'items-{i}-cgst_percent', ''),
                    'discount_percent': request.form.get(f'items-{i}-discount_percent', ''),
                    'amount': request.form.get(f'items-{i}-amount', ''),
                }
                for i in range(rowcount)
            ]
            rowcount += 1
            items.append({})
            return render_template('sales.html', patients=patients, doctors=doctors, medicines=medicines,
                                   rowcount=rowcount, invoice_no=invoice_no, sale_date=sale_date,
                                   patient_name=patient_name, doctor_name=doctor_name,
                                   grand_total_mrp=grand_total_mrp, grand_total_actual=grand_total_actual,
                                   savings_total=savings_total, items=items,
                                   show_bill=show_bill, bill_data=bill_data, sales_history=sales_history, edit_sale_id=request.form.get('edit_sale_id'),
                                   enumerate=enumerate)

        if 'showbill_id' in request.form:
            sale_id = request.form.get('showbill_id')
            cursor.execute("""
                SELECT s.*, p.name as patient_name, d.name as doctor_name
                FROM sales s
                LEFT JOIN patients p ON s.patient_id = p.id
                LEFT JOIN doctors d ON s.doctor_id = d.id
                WHERE s.id = %s
            """, (sale_id,))
            sale = cursor.fetchone()
            cursor.execute("""
                SELECT si.*, m.name
                FROM sales_items si
                JOIN medicines m ON si.product_id = m.id
                WHERE si.sale_id = %s
            """, (sale_id,))
            items_bill = cursor.fetchall()
            bill_data = {'sale': sale, 'items': items_bill}
            show_bill = True

            rowcount = 1
            invoice_no = generate_invoice_no()
            sale_date = datetime.datetime.now().strftime('%Y-%m-%d')
            patient_name = doctor_name = ''
            grand_total_mrp = grand_total_actual = savings_total = ''
            items = [{}]

            return render_template('sales.html', patients=patients, doctors=doctors, medicines=medicines,
                                   rowcount=rowcount, invoice_no=invoice_no, sale_date=sale_date,
                                   patient_name=patient_name, doctor_name=doctor_name,
                                   grand_total_mrp=grand_total_mrp, grand_total_actual=grand_total_actual,
                                   savings_total=savings_total, items=items,
                                   show_bill=show_bill, bill_data=bill_data, sales_history=sales_history,
                                   enumerate=enumerate)

        # Delete sale
        elif 'delsale_id' in request.form:
            del_id = int(request.form.get('delsale_id'))
            # First, get the items to restore stock
            cursor.execute("SELECT product_id, quantity FROM sales_items WHERE sale_id=%s", (del_id,))
            items_to_restore = cursor.fetchall()
            for item in items_to_restore:
                cursor.execute("UPDATE medicines SET stock_qty = stock_qty + %s WHERE id = %s", (item['quantity'], item['product_id']))
            # Delete sales items and sale
            cursor.execute("DELETE FROM sales_items WHERE sale_id=%s", (del_id,))
            cursor.execute("DELETE FROM sales WHERE id=%s", (del_id,))
            conn.commit()
            # Refresh history
            cursor.execute("""
                SELECT s.id, s.invoice_no, s.sale_datetime, s.total_amount, p.name AS patient_name,
                       COALESCE(cnt.item_qty, 0) AS item_count
                  FROM sales s
                  LEFT JOIN patients p ON s.patient_id = p.id
                  LEFT JOIN (
                    SELECT sale_id, SUM(quantity) AS item_qty
                      FROM sales_items
                     GROUP BY sale_id
                  ) cnt ON cnt.sale_id = s.id
                 ORDER BY s.sale_datetime DESC, s.id DESC
            """)
            sales_history = cursor.fetchall()
            return render_template('sales.html', patients=patients, doctors=doctors, medicines=medicines,
                                   rowcount=1, invoice_no='', sale_date='',
                                   patient_name='', doctor_name='',
                                   grand_total_mrp='', grand_total_actual='',
                                   savings_total='', items=[{}],
                                   show_bill=False, bill_data=None, sales_history=sales_history,
                                   enumerate=enumerate)

        if 'savesale' in request.form:
            # Validation
            errors = []
            if not patient_name.strip():
                errors.append("Patient name is required.")
            if rowcount == 0:
                errors.append("At least one item is required.")
            valid_items = 0
            for i in range(rowcount):
                prod_name = request.form.get(f'items-{i}-product', '').strip()
                qty = request.form.get(f'items-{i}-quantity', '').strip()
                rate = request.form.get(f'items-{i}-rate', '').strip()
                if prod_name and qty and rate:
                    try:
                        qty_val = int(qty)
                        rate_val = float(rate)
                        if qty_val <= 0 or rate_val <= 0:
                            errors.append(f"Item {i+1}: Quantity and rate must be positive.")
                        else:
                            valid_items += 1
                    except ValueError:
                        errors.append(f"Item {i+1}: Invalid quantity or rate.")
                elif prod_name or qty or rate:
                    errors.append(f"Item {i+1}: Incomplete item data.")
            if valid_items == 0:
                errors.append("At least one complete item is required.")
            if not grand_total_actual.strip():
                errors.append("Grand total is required.")
            if errors:
                for error in errors:
                    flash(error, "danger")
                # Collect items for render
                items = [
                    {
                        'product': request.form.get(f'items-{i}-product', ''),
                        'batch_no': request.form.get(f'items-{i}-batch_no', ''),
                        'expiry_date': request.form.get(f'items-{i}-expiry_date', ''),
                        'hsn_code': request.form.get(f'items-{i}-hsn_code', ''),
                        'mrp': request.form.get(f'items-{i}-mrp', ''),
                        'quantity': request.form.get(f'items-{i}-quantity', ''),
                        'rate': request.form.get(f'items-{i}-rate', ''),
                        'sgst_percent': request.form.get(f'items-{i}-sgst_percent', ''),
                        'cgst_percent': request.form.get(f'items-{i}-cgst_percent', ''),
                        'discount_percent': request.form.get(f'items-{i}-discount_percent', ''),
                        'amount': request.form.get(f'items-{i}-amount', ''),
                    }
                    for i in range(rowcount)
                ]
                return render_template('sales.html', patients=patients, doctors=doctors, medicines=medicines,
                                       rowcount=rowcount, invoice_no=invoice_no, sale_date=sale_date,
                                       patient_name=patient_name, doctor_name=doctor_name,
                                       grand_total_mrp=grand_total_mrp, grand_total_actual=grand_total_actual, edit_sale_id=edit_sale_id,
                                       savings_total=savings_total, items=items,
                                       show_bill=False, bill_data=None, sales_history=sales_history,
                                       enumerate=enumerate)

            # Check for duplicate invoice_no
            edit_sale_id = request.form.get('edit_sale_id', '').strip()
            if edit_sale_id: # This will now correctly handle non-empty strings
                # When editing, check for duplicate invoice on OTHER records
                cursor.execute("SELECT id FROM sales WHERE invoice_no = %s AND id != %s", (invoice_no, edit_sale_id))
            else:
                # When creating, check for any duplicate invoice
                cursor.execute("SELECT id FROM sales WHERE invoice_no = %s", (invoice_no,))
            if cursor.fetchone():
                flash("Invoice number already exists. Please try again.", "danger")
                # Collect items for render
                items = [
                    {
                        'product': request.form.get(f'items-{i}-product', ''),
                        'batch_no': request.form.get(f'items-{i}-batch_no', ''),
                        'expiry_date': request.form.get(f'items-{i}-expiry_date', ''),
                        'hsn_code': request.form.get(f'items-{i}-hsn_code', ''),
                        'mrp': request.form.get(f'items-{i}-mrp', ''),
                        'quantity': request.form.get(f'items-{i}-quantity', ''),
                        'rate': request.form.get(f'items-{i}-rate', ''),
                        'sgst_percent': request.form.get(f'items-{i}-sgst_percent', ''),
                        'cgst_percent': request.form.get(f'items-{i}-cgst_percent', ''),
                        'discount_percent': request.form.get(f'items-{i}-discount_percent', ''),
                        'amount': request.form.get(f'items-{i}-amount', ''),
                    }
                    for i in range(rowcount)
                ]
                return render_template('sales.html', patients=patients, doctors=doctors, medicines=medicines,
                                       rowcount=rowcount, invoice_no=invoice_no, sale_date=sale_date,
                                       patient_name=patient_name, doctor_name=doctor_name,
                                       grand_total_mrp=grand_total_mrp, grand_total_actual=grand_total_actual, edit_sale_id=edit_sale_id,
                                       savings_total=savings_total, items=items,
                                       show_bill=False, bill_data=None, sales_history=sales_history,
                                       enumerate=enumerate)

            patient_id = None
            doctor_id = None
            for p in patients:
                if p['name'].strip().lower() == patient_name.lower():
                    patient_id = p['id']
            if not patient_id and patient_name:
                cursor.execute("INSERT INTO patients (name, contact_number) VALUES (%s, %s)", (patient_name, patient_contact))
                patient_id = cursor.lastrowid

            for d in doctors:
                if d['name'].strip().lower() == doctor_name.lower():
                    doctor_id = d['id']
            if not doctor_id and doctor_name:
                cursor.execute("INSERT INTO doctors (name) VALUES (%s)", (doctor_name,))
                doctor_id = cursor.lastrowid

            if edit_sale_id:
                # This is an update to an existing sale
                sale_id = int(edit_sale_id)
                # Restore stock for old items before updating
                cursor.execute("SELECT product_id, quantity FROM sales_items WHERE sale_id=%s", (sale_id,))
                items_to_restore = cursor.fetchall()
                for item in items_to_restore:
                    cursor.execute("UPDATE medicines SET stock_qty = stock_qty + %s WHERE id = %s", (item['quantity'], item['product_id']))
                # Delete old items
                cursor.execute("DELETE FROM sales_items WHERE sale_id=%s", (sale_id,))
                # Update sale header - use current datetime for edited sale
                cursor.execute("""
                    UPDATE sales SET patient_id=%s, doctor_id=%s, invoice_no=%s, sale_datetime=%s, total_amount=%s
                    WHERE id=%s
                """, (patient_id, doctor_id, invoice_no, datetime.datetime.now(), float(grand_total_actual or 0), sale_id))
            else:
                # This is a new sale
                sale_datetime = datetime.datetime.now()
                cursor.execute("""
                    INSERT INTO sales (patient_id, doctor_id, invoice_no, sale_datetime, discount_value, gst_value, total_amount)
                    VALUES (%s, %s, %s, %s, %s, %s, %s)
                """, (patient_id, doctor_id, invoice_no, sale_datetime, 0, 0, float(grand_total_actual or 0)))
                sale_id = cursor.lastrowid
            total_item_mrp = total_actual_amt = total_savings = 0.0

            for i in range(rowcount):
                prod_name = request.form.get(f'items-{i}-product', '').strip()
                if not prod_name:
                    continue
                batch_no = request.form.get(f'items-{i}-batch_no', '')
                expiry_date = request.form.get(f'items-{i}-expiry_date', None)
                packing = request.form.get(f'items-{i}-packing', '')
                hsn_code = request.form.get(f'items-{i}-hsn_code', '')
                mrp_str = request.form.get(f'items-{i}-mrp', '').strip()
                mrp = float(mrp_str) if mrp_str else 0.0
                qty_str = request.form.get(f'items-{i}-quantity', '').strip()
                qty = int(qty_str) if qty_str else 0
                rate_str = request.form.get(f'items-{i}-rate', '').strip()
                rate = float(rate_str) if rate_str else 0.0
                sgst_str = request.form.get(f'items-{i}-sgst_percent', '').strip()
                sgst = float(sgst_str) if sgst_str else 0.0
                cgst_str = request.form.get(f'items-{i}-cgst_percent', '').strip()
                cgst = float(cgst_str) if cgst_str else 0.0
                dis_str = request.form.get(f'items-{i}-discount_percent', '').strip()
                dis = float(dis_str) if dis_str else 0.0

                amount_input = request.form.get(f'items-{i}-amount', '').strip()
                if amount_input:
                    amount = float(amount_input)
                else:
                    base = qty * rate
                    discount_amt = base * dis / 100
                    amount = base - discount_amt

                medicine_id = None
                for m in medicines:
                    if m['name'].strip().lower() == prod_name.lower() and m['batch_no'] == batch_no and str(m['expiry_date']) == str(expiry_date) and str(m.get('packing') or '') == str(packing or ''):
                        medicine_id = m['id']

                if not medicine_id and prod_name:
                    cursor.execute("""
                        INSERT INTO medicines (name, batch_no, expiry_date, hsn_code, mrp, sgst_percent, cgst_percent, stock_qty, packing)
                        VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s)
                    """, (prod_name, batch_no, expiry_date, hsn_code, mrp, sgst, cgst, 0, packing))
                    medicine_id = cursor.lastrowid

                if medicine_id:
                    cursor.execute("UPDATE medicines SET stock_qty = stock_qty - %s WHERE id = %s", (qty, medicine_id))

                item_mrp_total = (mrp * qty) + ((mrp*qty)*sgst/100) + ((mrp*qty)*cgst/100)
                total_item_mrp += item_mrp_total
                total_actual_amt += amount
                total_savings += item_mrp_total - amount

                cursor.execute("""
                    INSERT INTO sales_items (sale_id, product_id, quantity, price, amount, batch_no, expiry_date, hsn_code, mrp, sgst_percent, cgst_percent, discount_percent)
                    VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)
                """, (sale_id, medicine_id, qty, rate, amount, batch_no, expiry_date, hsn_code, mrp, sgst, cgst, dis))

            cursor.execute("UPDATE sales SET total_amount=%s WHERE id=%s", (float(grand_total_actual or 0), sale_id))
            conn.commit()
            if edit_sale_id:
                flash("Sale updated successfully", "success")
            else:
                flash("Sale saved successfully", "success")
            cursor.execute("""
                SELECT s.*, p.name as patient_name, d.name as doctor_name
                FROM sales s
                LEFT JOIN patients p ON s.patient_id = p.id
                LEFT JOIN doctors d ON s.doctor_id = d.id
                WHERE s.id = %s
            """, (sale_id,))
            sale = cursor.fetchone()
            cursor.execute("""
                SELECT si.*, m.name
                FROM sales_items si
                JOIN medicines m ON si.product_id = m.id
                WHERE si.sale_id = %s
            """, (sale_id,))
            items_bill = cursor.fetchall()
            bill_data = {'sale': sale, 'items': items_bill}
            show_bill = True

            rowcount = 1
            invoice_no = generate_invoice_no()
            sale_date = datetime.datetime.now().strftime('%Y-%m-%d')
            patient_name = doctor_name = ''
            grand_total_mrp, grand_total_actual, savings_total = total_item_mrp, total_actual_amt, total_savings
            items = [{}]

    cursor.close()
    conn.close()

    if not items:
        items = [{}]

    return render_template('sales.html', patients=patients, doctors=doctors, medicines=medicines,
                           rowcount=rowcount, invoice_no=invoice_no, sale_date=sale_date,
                           patient_name=patient_name, doctor_name=doctor_name,
                           grand_total_mrp=grand_total_mrp, grand_total_actual=grand_total_actual,
                           savings_total=savings_total, items=items,
                           show_bill=show_bill, bill_data=bill_data, sales_history=sales_history, enumerate=enumerate)

@app.route('/purchases', methods=['GET', 'POST'])
def purchases_view():
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT * FROM medicines ORDER BY name;")
    medicines = cursor.fetchall()
    cursor.execute("SELECT * FROM distributors ORDER BY name;")
    distributors = cursor.fetchall()

    cursor.execute("""
        SELECT p.id, p.invoice_no, p.purchase_date, d.name as distributor_name, d.trade_type, 
            p.total_amount
        FROM purchases p
        LEFT JOIN distributors d ON p.distributor_id = d.id
        ORDER BY p.purchase_date DESC, p.id DESC;
    """)
    purchases_history = cursor.fetchall()

    rowcount = 1
    invoice_no = purchase_date = datetime.datetime.now().strftime('%Y-%m-%d')
    distributor_name = trade_type = grand_total = ''
    discount_percent = '0'
    distributor_contact = ''
    distributor_id = None
    items = []
    show_detail = False
    purchase_detail = None
    editing_purchase = None
    edit_purchase_id = None

    if request.method == 'POST':
        try:
            rowcount = int(request.form.get('rowcount', 1))
        except ValueError:
            rowcount = 1
        invoice_no = request.form.get('invoice_no', '')
        purchase_date = request.form.get('purchase_date', '') or ''
        distributor_name = request.form.get('distributor_name', '').strip()
        distributor_contact = request.form.get('distributor_contact', '').strip()
        trade_type = request.form.get('trade_type', '')
        grand_total = request.form.get('grand_total', '')
        header_discount_percent = request.form.get('discount_percent', '').strip() or '0'
    
        items = []
        for i in range(rowcount):
            gst_percent = str(float(request.form.get(f'items-{i}-sgst_percent', '0') or '0') + float(request.form.get(f'items-{i}-cgst_percent', '0') or '0'))
            items.append({
                'product': request.form.get(f'items-{i}-product', ''),
                'batch_no': request.form.get(f'items-{i}-batch_no', ''),
                'expiry_date': request.form.get(f'items-{i}-expiry_date', ''),
                'packing': request.form.get(f'items-{i}-packing', ''),
                'free': request.form.get(f'items-{i}-free', '0'),
                'sgst_percent': request.form.get(f'items-{i}-sgst_percent', ''),
                'cgst_percent': request.form.get(f'items-{i}-cgst_percent', ''),
                'gst_percent': gst_percent,
                'hsn_code': request.form.get(f'items-{i}-hsn_code', ''),
                'mrp': request.form.get(f'items-{i}-mrp', ''),
                'quantity': request.form.get(f'items-{i}-quantity', ''),
                'rate': request.form.get(f'items-{i}-rate', ''),
                'discount_percent': request.form.get(f'items-{i}-discount_percent', ''),
                'amount': request.form.get(f'items-{i}-amount', ''),
                'sale_rate': request.form.get(f'items-{i}-sale_rate', ''),
                'sale_discount_percent': request.form.get(f'items-{i}-sale_discount_percent', ''),
            })
    
        # Delete purchase
        if "delpurchase_id" in request.form:
            del_id = int(request.form.get("delpurchase_id"))
            # First, get the items to restore stock
            cursor.execute("SELECT product_id, quantity, `free` FROM purchase_items WHERE purchase_id=%s", (del_id,))
            items_to_restore = cursor.fetchall()
            for item in items_to_restore:
                restore_amount = int(item.get('quantity') or 0) + int(item.get('free') or 0)
                cursor.execute("UPDATE medicines SET stock_qty = stock_qty - %s WHERE id = %s", (restore_amount, item['product_id']))
            # Delete purchase items and purchase
            cursor.execute("DELETE FROM purchase_items WHERE purchase_id=%s", (del_id,))
            cursor.execute("DELETE FROM purchases WHERE id=%s", (del_id,))
            conn.commit()
            # Refresh history
            cursor.execute("""
                SELECT p.id, p.invoice_no, p.purchase_date, d.name as distributor_name, d.trade_type,
                    p.total_amount
                FROM purchases p
                LEFT JOIN distributors d ON p.distributor_id = d.id
                ORDER BY p.purchase_date DESC, p.id DESC;
            """)
            purchases_history = cursor.fetchall()
            return render_template('purchases.html', purchases_history=purchases_history, medicines=medicines,
                                  distributors=distributors, rowcount=1, invoice_no='', purchase_date='',
                                  distributor_name='', trade_type='', grand_total='', items=[{}],
                                  show_detail=False, purchase_detail=None, discount_percent=discount_percent,
                                  enumerate=enumerate)
                                      enumerate=enumerate)
    
            # Show detail for purchase
            if "showdetail_id" in request.form:
                show_id = int(request.form.get("showdetail_id"))
                cursor.execute("""
                    SELECT p.*, d.name as distributor_name, d.trade_type, d.contact_number
                    FROM purchases p
                    LEFT JOIN distributors d ON p.distributor_id = d.id
                    WHERE p.id = %s
                """, (show_id,))
                purchase = cursor.fetchone()
                cursor.execute("""
                    SELECT pi.*, COALESCE(m.name, 'Deleted Product') as name FROM purchase_items pi
                    LEFT JOIN medicines m ON pi.product_id = m.id
                    WHERE pi.purchase_id = %s
                """, (show_id,))
                item_list = cursor.fetchall()
                # Build purchase_detail for display and also prepare `items` shaped for the edit/form template
                purchase_detail = {'purchase': purchase, 'items': item_list}
                show_detail = True
                # Map DB rows to the form's expected keys so the inline view/form renders correctly
                items_for_form = []
                for it in item_list:
                    items_for_form.append({
                        'product': it.get('name') or it.get('product') or '',
                        'packing': it.get('packing') or '',
                        'batch_no': it.get('batch_no') or '',
                        'expiry_date': it.get('expiry_date') or '',
                        'hsn_code': it.get('hsn_code') or '',
                        'mrp': it.get('mrp') or 0,
                        'quantity': it.get('quantity') or 0,
                        'free': it.get('free') or 0,
                        'rate': it.get('rate') or 0,
                        'sgst_percent': it.get('sgst_percent') or 0,
                        'cgst_percent': it.get('cgst_percent') or 0,
                        'discount_percent': it.get('discount_percent') or 0,
                        'amount': it.get('amount') or 0,
                        'sale_rate': it.get('sale_rate') or 0,
                        'sale_discount_percent': it.get('sale_discount_percent') or 0,
                        'product_id': it.get('product_id')
                    })
                rowcount = len(items_for_form) if items_for_form else 1
                return render_template('purchases.html', purchases_history=purchases_history, medicines=medicines,
                                      distributors=distributors, rowcount=rowcount, invoice_no='', purchase_date='',
                                      distributor_name='', trade_type='', grand_total='', items=items_for_form,
                                      show_detail=show_detail, purchase_detail=purchase_detail,
                                      editing_purchase=None, edit_purchase_id=None, discount_percent=discount_percent,
                                      enumerate=enumerate)
    
        # Start editing purchase
        if "startedit_id" in request.form:
            edit_id = int(request.form.get("startedit_id"))
            cursor.execute("""
                SELECT p.*, d.name as distributor_name, d.trade_type, d.contact_number
                FROM purchases p
                LEFT JOIN distributors d ON p.distributor_id = d.id
                WHERE p.id = %s
            """, (edit_id,))
            editing_purchase = cursor.fetchone()
            cursor.execute("""
                SELECT pi.*, COALESCE(m.name, 'Deleted Product') as product, m.packing FROM purchase_items pi
                LEFT JOIN medicines m ON pi.product_id = m.id
                WHERE pi.purchase_id = %s
            """, (edit_id,))
            item_list = cursor.fetchall()
            items = []
            for item in item_list:
                gst_percent = (item['sgst_percent'] or 0) + (item['cgst_percent'] or 0)
                items.append({
                    'product': item['product'],
                    'batch_no': item['batch_no'],
                    'expiry_date': item['expiry_date'],
                    'packing': item['packing'],
                    'free': item.get('free', 0),
                    'hsn_code': item['hsn_code'],
                    'mrp': item['mrp'],
                    'quantity': item['quantity'],
                    'rate': item['rate'],
                    'sgst_percent': item['sgst_percent'],
                    'cgst_percent': item['cgst_percent'],
                    'gst_percent': gst_percent,
                    'discount_percent': item['discount_percent'],
                    'amount': item['amount'],
                    'sale_rate': item['sale_rate'],
                    'sale_discount_percent': item['sale_discount_percent'],
                    'product_id': item['product_id'],
                })
            rowcount = len(items) if items else 1
            return render_template('purchases.html', purchases_history=purchases_history, medicines=medicines,
                                  distributors=distributors, rowcount=rowcount, invoice_no=editing_purchase['invoice_no'],
                                  purchase_date=editing_purchase['purchase_date'].strftime('%Y-%m-%d') if editing_purchase['purchase_date'] else '',
                                  distributor_name=editing_purchase['distributor_name'],
                                  trade_type=editing_purchase['trade_type'], grand_total=editing_purchase['total_amount'], items=items,
                                  show_detail=False, purchase_detail=None, editing_purchase=editing_purchase, edit_purchase_id=edit_id,
                                  enumerate=enumerate)
                
            # Remove Row
            if "delrow" in request.form:
                del_idx = int(request.form['delrow'])
                items = [item for idx, item in enumerate(items) if idx != del_idx]
                rowcount = max(1, len(items))
                for item in items:
                    item['sgst_percent'] = item.get('sgst_percent', '')
                    item['cgst_percent'] = item.get('cgst_percent', '')
                    item['gst_percent'] = str(float(item.get('sgst_percent', '0') or '0') + float(item.get('cgst_percent', '0') or '0'))
                return render_template('purchases.html', purchases_history=purchases_history, medicines=medicines,
                                      distributors=distributors, rowcount=rowcount, invoice_no=invoice_no,
                                      purchase_date=purchase_date, distributor_name=distributor_name,
                                      trade_type=trade_type, grand_total=grand_total, items=items,
                                      show_detail=show_detail, purchase_detail=purchase_detail,
                                      editing_purchase=editing_purchase, edit_purchase_id=edit_purchase_id, discount_percent=discount_percent,
                                      enumerate=enumerate)
            
            # Add Row
            if "addrow" in request.form:
                rowcount += 1
                items.append({})
                for item in items:
                    item['sgst_percent'] = item.get('sgst_percent', '')
                    item['cgst_percent'] = item.get('cgst_percent', '')
                    item['gst_percent'] = str(float(item.get('sgst_percent', '0') or '0') + float(item.get('cgst_percent', '0') or '0'))
                return render_template('purchases.html', purchases_history=purchases_history, medicines=medicines,
                                      distributors=distributors, rowcount=rowcount, invoice_no=invoice_no,
                                      purchase_date=purchase_date, distributor_name=distributor_name,
                                      trade_type=trade_type, grand_total=grand_total, items=items,
                                      show_detail=show_detail, purchase_detail=purchase_detail,
                                      editing_purchase=editing_purchase, edit_purchase_id=edit_purchase_id, discount_percent=discount_percent,
                                      enumerate=enumerate)
            
        # Save Purchase
        if "savepurchase" in request.form:
            # Capture incoming form for debugging: write form keys/values to a file
            try:
                import json, os
                capture_file = os.path.join(os.path.dirname(__file__), 'purchase_form_capture.txt')
                with open(capture_file, 'a', encoding='utf-8') as cf:
                    cf.write('\n---- %s ----\n' % (datetime.datetime.now().isoformat()))
                    try:
                        form_dict = request.form.to_dict(flat=False)
                        cf.write(json.dumps(form_dict, default=str, indent=2))
                    except Exception:
                        cf.write(str(dict(request.form)))
            except Exception:
                pass

            try:
                    edit_purchase_id = request.form.get('edit_purchase_id')
                    if edit_purchase_id and edit_purchase_id.strip():
                        edit_purchase_id = int(edit_purchase_id)
                    else:
                        edit_purchase_id = None
                    # Initialize updated_product_ids to avoid UnboundLocalError
                    updated_product_ids = []
                    # Validation
                    errors = []
                    if not distributor_name.strip():
                        errors.append("Distributor name is required.")
                    if rowcount == 0:
                        errors.append("At least one item is required.")
                    valid_items = 0
                    for i in range(rowcount):
                        prod_name = request.form.get(f'items-{i}-product', '').strip()
                        qty = request.form.get(f'items-{i}-quantity', '').strip()
                        rate = request.form.get(f'items-{i}-rate', '').strip()
                        if prod_name and qty and rate:
                            try:
                                qty_val = int(qty)
                                rate_val = float(rate)
                                if qty_val <= 0 or rate_val <= 0:
                                    errors.append(f"Item {i+1}: Quantity and rate must be positive.")
                                else:
                                    valid_items += 1
                            except ValueError:
                                errors.append(f"Item {i+1}: Invalid quantity or rate.")
                        elif prod_name or qty or rate:
                            errors.append(f"Item {i+1}: Incomplete item data.")
                    if valid_items == 0:
                        errors.append("At least one complete item is required.")
                    if not grand_total.strip():
                        errors.append("Grand total is required.")
                    if errors:
                        for error in errors:
                            flash(error, "danger")
                        return render_template('purchases.html', purchases_history=purchases_history, medicines=medicines,
                                              distributors=distributors, rowcount=rowcount, invoice_no=invoice_no,
                                              purchase_date=purchase_date, distributor_name=distributor_name,
                                              trade_type=trade_type, grand_total=grand_total, items=items, edit_purchase_id=edit_purchase_id,
                                              show_detail=show_detail, purchase_detail=purchase_detail,
                                              editing_purchase=editing_purchase, discount_percent=discount_percent)
    
                    distributor_id = None
                    for d in distributors:
                        if d['name'].strip().lower() == distributor_name.lower() and d['trade_type'] == trade_type:
                            distributor_id = d['id']
                            break
                    if not distributor_id and distributor_name:
                        if edit_purchase_id:
                            # For editing, update the existing distributor instead of creating new
                            purchase_id = int(edit_purchase_id)
                            cursor.execute("SELECT distributor_id FROM purchases WHERE id=%s", (purchase_id,))
                            current_dist = cursor.fetchone()
                            if current_dist and current_dist['distributor_id']:
                                cursor.execute("UPDATE distributors SET name=%s, contact_number=%s, trade_type=%s WHERE id=%s", (distributor_name, distributor_contact, trade_type or "Retail", current_dist['distributor_id']))
                                distributor_id = current_dist['distributor_id']
                            else:
                                cursor.execute(
                                    "INSERT INTO distributors (name, trade_type, contact_number) VALUES (%s, %s, %s)",
                                    (distributor_name, trade_type or "Retail", distributor_contact)
                                )
                                distributor_id = cursor.lastrowid
                        else:
                            cursor.execute(
                                "INSERT INTO distributors (name, trade_type, contact_number) VALUES (%s, %s, %s)",
                                (distributor_name, trade_type or "Retail", distributor_contact)
                            )
                            distributor_id = cursor.lastrowid
                    if edit_purchase_id:
                    # Show detail for purchase
                    if "showdetail_id" in request.form:
                        show_id = int(request.form.get("showdetail_id"))
                        cursor.execute("""
                            SELECT p.*, d.name as distributor_name, d.trade_type, d.contact_number
                            FROM purchases p
                            LEFT JOIN distributors d ON p.distributor_id = d.id
                            WHERE p.id = %s
                        """, (show_id,))
                        purchase = cursor.fetchone()
                        cursor.execute("""
                            SELECT pi.*, COALESCE(m.name, 'Deleted Product') as name FROM purchase_items pi
                            LEFT JOIN medicines m ON pi.product_id = m.id
                            WHERE pi.purchase_id = %s
                        """, (show_id,))
                        item_list = cursor.fetchall()
                        # Build purchase_detail for display and also prepare `items` shaped for the edit/form template
                        purchase_detail = {'purchase': purchase, 'items': item_list}
                        show_detail = True
                        # Map DB rows to the form's expected keys so the inline view/form renders correctly
                        items_for_form = []
                        for it in item_list:
                            items_for_form.append({
                                'product': it.get('name') or it.get('product') or '',
                                'packing': it.get('packing') or '',
                                'batch_no': it.get('batch_no') or '',
                                'expiry_date': it.get('expiry_date') or '',
                                'hsn_code': it.get('hsn_code') or '',
                                'mrp': it.get('mrp') or 0,
                                'quantity': it.get('quantity') or 0,
                                'free': it.get('free') or 0,
                                'rate': it.get('rate') or 0,
                                'sgst_percent': it.get('sgst_percent') or 0,
                                'cgst_percent': it.get('cgst_percent') or 0,
                                'discount_percent': it.get('discount_percent') or 0,
                                'amount': it.get('amount') or 0,
                                'sale_rate': it.get('sale_rate') or 0,
                                'sale_discount_percent': it.get('sale_discount_percent') or 0,
                                'product_id': it.get('product_id')
                            })
                        rowcount = len(items_for_form) if items_for_form else 1
                        return render_template('purchases.html', purchases_history=purchases_history, medicines=medicines,
                                              distributors=distributors, rowcount=rowcount, invoice_no='', purchase_date='',
                                              distributor_name='', trade_type='', grand_total='', items=items_for_form,
                                              show_detail=show_detail, purchase_detail=purchase_detail,
                                              editing_purchase=None, edit_purchase_id=None, discount_percent=discount_percent,
                                              enumerate=enumerate)
                        rate = float(row.get('rate') or 0)
                        # Collect gst_percent from form and split into sgst and cgst (assume equal split)
                        sgst_str = row.get('sgst_percent', '0').strip() or '0'
                        cgst_str = row.get('cgst_percent', '0').strip() or '0'
                        sgst = float(sgst_str)
                        cgst = float(cgst_str)
                        discount = float(row.get('discount_percent') or 0)
                        sale_rate = 0
                        if row.get('sale_rate') and str(row.get('sale_rate')).strip():
                            sale_rate = float(row.get('sale_rate'))
                        sale_discount_percent = 0
                        if row.get('sale_discount_percent') and str(row.get('sale_discount_percent')).strip():
                            sale_discount_percent = float(row.get('sale_discount_percent'))
    
                        # Per requirement: Purchase Rate * Qty = Amount (base amount stored)
                        base = qty * rate
                        amount = float(base)
                        per_item_discount_amt = base * (discount / 100.0)
                        taxable = base - per_item_discount_amt
                        gst_amt = taxable * ((sgst + cgst) / 100.0)
                        total_amount_base += base
                        total_gst += gst_amt
    
                        medicine_id = None
                        if edit_purchase_id and 'product_id' in row and row['product_id']:
                            # Update existing medicine for editing
                            current_update_params = [prod_name, batch_no, expiry, hsn, mrp, sgst, cgst]
                            if rate > 0 and sale_rate > 0:
                                current_update_params.extend([rate, sale_rate, sale_discount_percent])
                                current_update_params.append(row['product_id'])
                                cursor.execute("""
                                    UPDATE medicines SET name=%s, batch_no=%s, expiry_date=%s, hsn_code=%s, mrp=%s, sgst_percent=%s, cgst_percent=%s,
                                    purchase_rate=%s, sale_rate=%s, sale_discount_percent=%s
                                    WHERE id=%s
                                """, tuple(current_update_params))
                            elif rate > 0:
                                current_update_params.extend([rate])
                                current_update_params.append(row['product_id'])
                                cursor.execute("""
                                    UPDATE medicines SET name=%s, batch_no=%s, expiry_date=%s, hsn_code=%s, mrp=%s, sgst_percent=%s, cgst_percent=%s,
                                    purchase_rate=%s
                                    WHERE id=%s
                                """, tuple(current_update_params))
                            elif sale_rate > 0:
                                current_update_params.append(row['product_id'])
                                cursor.execute("""
                                    UPDATE medicines SET name=%s, batch_no=%s, expiry_date=%s, hsn_code=%s, mrp=%s, sgst_percent=%s, cgst_percent=%s,
                                    sale_rate=%s, sale_discount_percent=%s
                                    WHERE id=%s
                                """, (prod_name, batch_no, expiry, hsn, mrp, sgst, cgst, sale_rate, sale_discount_percent, row['product_id']))
                            else:
                                cursor.execute("""
                                    UPDATE medicines SET name=%s, batch_no=%s, expiry_date=%s, hsn_code=%s, mrp=%s, sgst_percent=%s, cgst_percent=%s
                                    WHERE id=%s
                                """, (prod_name, batch_no, expiry, hsn, mrp, sgst, cgst, row['product_id']))
    
                            medicine_id = row['product_id']
                            add_qty = qty + free if is_wholesale else qty
                            cursor.execute("UPDATE medicines SET stock_qty = stock_qty + %s WHERE id = %s", (add_qty, medicine_id))
                        else:
                            # For new purchases or new items in edit, check if exists
                            cursor.execute(
                                "SELECT id FROM medicines WHERE name=%s AND batch_no=%s AND expiry_date=%s AND COALESCE(packing,'')=%s LIMIT 1",
                                (prod_name, batch_no, expiry, packing)
                            )
                            med_exist = cursor.fetchone()
                            if med_exist:
                                medicine_id = med_exist['id']
                                # Update purchase_rate and sale_rate only if positive
                                add_qty = qty + free if is_wholesale else qty
                                update_params = [add_qty]
                                update_set_parts = ["stock_qty = stock_qty + %s"]
                                if rate > 0:
                                    update_set_parts.append("purchase_rate = %s")
                                    update_params.append(rate)
                                if sale_rate > 0:
                                    update_set_parts.append("sale_rate = %s")
                                    update_params.append(sale_rate)
                                    update_set_parts.append("sale_discount_percent = %s")
                                    update_params.append(sale_discount_percent)
                                if packing:
                                    update_set_parts.append("packing = %s")
                                    update_params.append(packing)
                                update_params.append(medicine_id)
                                update_sql = f"UPDATE medicines SET {', '.join(update_set_parts)} WHERE id = %s"
                                cursor.execute(update_sql, tuple(update_params))
                            else:
                                insert_stock = qty + free if is_wholesale else qty
                                cursor.execute("""
                                    INSERT INTO medicines (name, batch_no, expiry_date, hsn_code, mrp, sgst_percent, cgst_percent, stock_qty, purchase_rate, sale_rate, sale_discount_percent, packing)
                                    VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)
                                """, (prod_name, batch_no, expiry, hsn, mrp, sgst, cgst, insert_stock, rate, sale_rate, sale_discount_percent, packing))
                                medicine_id = cursor.lastrowid
    
                            if medicine_id:
                                updated_product_ids.append(medicine_id)
                                if edit_purchase_id and 'product_id' in row and row['product_id']:
                                    # Update existing purchase_item (include free)
                                    cursor.execute(
                                        """
                                        UPDATE purchase_items SET sr_no=%s, hsn_code=%s, batch_no=%s, expiry_date=%s, quantity=%s, `free`=%s, mrp=%s, rate=%s, sgst_percent=%s, cgst_percent=%s, discount_percent=%s, amount=%s, sale_rate=%s, sale_discount_percent=%s
                                        WHERE purchase_id=%s AND product_id=%s
                                        """,
                                        (idx + 1, hsn, batch_no, expiry, qty, free, mrp, rate, sgst, cgst, discount, amount, sale_rate, sale_discount_percent, purchase_id, medicine_id)
                                    )
                                else:
                                    # Insert new purchase_item (include free)
                                    cursor.execute(
                                        """
                                        INSERT INTO purchase_items (purchase_id, product_id, sr_no, hsn_code, batch_no, expiry_date, quantity, `free`, mrp, rate, sgst_percent, cgst_percent, discount_percent, amount, sale_rate, sale_discount_percent)
                                        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                                        """,
                                        (purchase_id, medicine_id, idx + 1, hsn, batch_no, expiry, qty, free, mrp, rate, sgst, cgst, discount, amount, sale_rate, sale_discount_percent)
                                    )
    
                    # Delete purchase_items not in the updated list
                    if edit_purchase_id and updated_product_ids:
                        # Build placeholders and params so the purchase_id is included in parameters
                        placeholders = ','.join(['%s'] * len(updated_product_ids))
                        params = [edit_purchase_id] + list(updated_product_ids)
                        cursor.execute(f"DELETE FROM purchase_items WHERE purchase_id=%s AND product_id NOT IN ({placeholders})", tuple(params))
    
                    # After persisting all items, compute and update purchase header totals (gst, discount)
                    try:
                        header_discount = float(header_discount_percent or 0)
                    except Exception:
                        header_discount = 0.0
                    header_discount_value = (total_amount_base * header_discount / 100.0) if total_amount_base else 0.0
                    final_grand_total = total_amount_base + total_gst - header_discount_value
                    # Check if grand_total is manually overwritten
                    if grand_total.strip():
                        # Use overwritten value, set gst and discount to 0
                        total_amount = float(grand_total)
                        gst_value = 0.0
                        discount_value = 0.0
                    else:
                        # Use computed value
                        total_amount = final_grand_total
                        gst_value = total_gst
                        discount_value = header_discount_value
                    # Update purchases row with totals
                    cursor.execute("UPDATE purchases SET total_amount=%s, gst_value=%s, discount_value=%s WHERE id=%s",
                                   (total_amount, gst_value, discount_value, purchase_id))
    
                    conn.commit()
                    return redirect(url_for('purchases_view'))
                except Exception as e:
                    import traceback, os
                    tb = traceback.format_exc()
                    # Write traceback to a file inside Backend for inspection
                    log_file = os.path.join(os.path.dirname(__file__), 'purchase_error_traceback.txt')
                    try:
                        with open(log_file, 'a', encoding='utf-8') as f:
                            f.write('\n\n' + tb)
                    except Exception:
                        pass
                    try:
                        conn.rollback()
                    except Exception:
                        pass
                    app.logger.exception('Error while saving purchase')
                    flash(f"An internal error occurred while saving the purchase. Traceback written to {log_file}", "danger")
                    return render_template('purchases.html', purchases_history=purchases_history, medicines=medicines,
                                          distributors=distributors, rowcount=rowcount, invoice_no=invoice_no,
                                          purchase_date=purchase_date, distributor_name=distributor_name,
                                          trade_type=trade_type, grand_total=grand_total, items=items, edit_purchase_id=edit_purchase_id,
                                          show_detail=show_detail, purchase_detail=purchase_detail,
                                          editing_purchase=editing_purchase, discount_percent=discount_percent,
                                          enumerate=enumerate)
    
    cursor.close()
    conn.close()
    if not items:
        items = [{}]
    return render_template('purchases.html', purchases_history=purchases_history, medicines=medicines,
                          distributors=distributors, rowcount=rowcount, invoice_no=invoice_no,
                          purchase_date=purchase_date, distributor_name=distributor_name,
                          trade_type=trade_type, grand_total=grand_total, items=items,
                          show_detail=show_detail, purchase_detail=purchase_detail, discount_percent=discount_percent)

@app.route('/medicines', methods=['GET', 'POST'])
def medicines_view():
    import datetime
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)

    # Delete medicine
    if request.method == 'POST' and "delmedicine_id" in request.form:
        mid = int(request.form.get('delmedicine_id'))
        # Check for sales or purchases
        cursor.execute("SELECT COUNT(*) as cnt FROM sales_items WHERE product_id=%s", (mid,))
        sales_cnt = cursor.fetchone()['cnt']
        cursor.execute("SELECT COUNT(*) as cnt FROM purchase_items WHERE product_id=%s", (mid,))
        purch_cnt = cursor.fetchone()['cnt']
        if sales_cnt > 0 or purch_cnt > 0:
            flash("Cannot delete medicine: linked to sales/purchases.", "danger")
        else:
            cursor.execute("DELETE FROM medicines WHERE id=%s", (mid,))
            conn.commit()

    # Add new medicine
    if request.method == 'POST' and "addmedicine" in request.form:
        name = request.form.get("name", "").strip()
        hsn_code = request.form.get("hsn_code", "")
        batch_no = request.form.get("batch_no", "")
        expiry_date = request.form.get("expiry_date", "")
        mrp = float(request.form.get("mrp") or 0)
        purchase_rate = float(request.form.get("purchase_price") or 0)
        sale_rate = float(request.form.get("price") or 0)
        stock_qty = int(request.form.get("stock_qty") or 0)
        sgst_percent = float(request.form.get("sgst_percent") or 0)
        cgst_percent = float(request.form.get("cgst_percent") or 0)
        distributor_name = request.form.get("distributor_name", "")
        packing_val = request.form.get("packing", "")
        cursor.execute("""
            INSERT INTO medicines (name, hsn_code, batch_no, expiry_date, mrp, purchase_rate, sale_rate, stock_qty,
                                   sgst_percent, cgst_percent, supplier_name, supplier_contact, packing)
            VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)
        """, (name, hsn_code, batch_no, expiry_date, mrp, purchase_rate, sale_rate, stock_qty, sgst_percent, cgst_percent, distributor_name, "", packing_val))
        conn.commit()
        flash("Medicine added successfully", "success")
    # Fetch all inventory
    cursor.execute("""
        SELECT * FROM medicines
        ORDER BY name, batch_no, expiry_date
    """)
    medicines = cursor.fetchall()

    # Mark medicines near expiry (expire in 30 days or less)
    def is_near_expiry(expiry_date_str):
        if not expiry_date_str:
            return False
        try:
            expiry_date = datetime.datetime.strptime(str(expiry_date_str), '%Y-%m-%d')
        except ValueError:
            try:
                expiry_date = datetime.datetime.strptime(str(expiry_date_str), '%Y-%m-%d %H:%M:%S')
            except Exception:
                return False
        today = datetime.datetime.today()
        delta = expiry_date - today
        return 0 <= delta.days <= 30

    for med in medicines:
        med['near_expiry'] = is_near_expiry(med.get('expiry_date'))


    # View medicine sales/purchases history: separate button triggers
    show_sales = show_purchases = False
    sales_history = purchases_history = []
    medicine_detail = None

    if request.method == 'POST' and "view_sales_id" in request.form:
        mid = int(request.form.get('view_sales_id'))
        cursor.execute("SELECT name FROM medicines WHERE id=%s", (mid,))
        med = cursor.fetchone()
        if med:
            name = med['name']
            cursor.execute("SELECT * FROM medicines WHERE id=%s", (mid,))
            medicine_detail = cursor.fetchone()
            show_sales = True
            cursor.execute("""
                SELECT s.id, s.invoice_no, s.sale_datetime, p.name as patient_name, SUM(si.quantity) as quantity, SUM(si.amount) as amount
                FROM sales_items si
                JOIN sales s ON si.sale_id = s.id
                LEFT JOIN patients p ON s.patient_id = p.id
                JOIN medicines m ON si.product_id = m.id
                WHERE m.name = %s
                GROUP BY s.id, s.invoice_no, s.sale_datetime, p.name
                ORDER BY s.sale_datetime DESC
            """, (name,))
            sales_history = cursor.fetchall()

    if request.method == 'POST' and "view_purchases_id" in request.form:
        mid = int(request.form.get('view_purchases_id'))
        cursor.execute("SELECT name FROM medicines WHERE id=%s", (mid,))
        med = cursor.fetchone()
        if med:
            name = med['name']
            cursor.execute("SELECT * FROM medicines WHERE id=%s", (mid,))
            medicine_detail = cursor.fetchone()
            show_purchases = True
            cursor.execute("""
                SELECT pu.invoice_no, pu.purchase_date, pi.quantity, pi.amount, d.name as distributor_name, m.batch_no, m.expiry_date
                FROM purchase_items pi
                JOIN purchases pu ON pi.purchase_id = pu.id
                LEFT JOIN distributors d ON pu.distributor_id = d.id
                JOIN medicines m ON pi.product_id = m.id
                WHERE m.name = %s
                ORDER BY pu.purchase_date DESC
            """, (name,))
            purchases_history = cursor.fetchall()

    cursor.close()
    conn.close()
    return render_template('medicines.html', medicines=medicines,
                           show_sales=show_sales, sales_history=sales_history,
                           show_purchases=show_purchases, purchases_history=purchases_history,
                           medicine_detail=medicine_detail)

@app.route('/patients', methods=['GET', 'POST'])
def patients_view():
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)

    # Fetch all patients in DB
    cursor.execute("SELECT * FROM patients ORDER BY name;")
    patients = cursor.fetchall()

    # To handle editing existing patient or viewing sale history
    editing_patient = None
    show_history = False
    sale_history = []

    if request.method == 'POST':
        # Add new patient
        if 'addpatient' in request.form:
            name = request.form.get('name', '').strip()
            contact_number = request.form.get('contact_number', '').strip()
            address = request.form.get('address', '').strip()
            if name:
                cursor.execute("""
                    INSERT INTO patients (name, contact_number, medical_history_notes)
                    VALUES (%s, %s, %s)
                """, (name, contact_number, address))
                conn.commit()
                flash("Patient added successfully", "success")
        # Edit patient
        elif 'editpatient_id' in request.form:
            edit_id = int(request.form['editpatient_id'])
            name = request.form.get('name', '').strip()
            contact_number = request.form.get('contact_number', '').strip()
            address = request.form.get('address', '').strip()
            cursor.execute("""
                UPDATE patients SET name=%s, contact_number=%s, medical_history_notes=%s WHERE id=%s
            """, (name, contact_number, address, edit_id))
            conn.commit()
            flash("Patient updated successfully", "success")
        # Start editing show form
        elif 'startedit_id' in request.form:
            edit_id = int(request.form['startedit_id'])
            cursor.execute("SELECT * FROM patients WHERE id=%s", (edit_id,))
            editing_patient = cursor.fetchone()

        # Show patient records (sales history)
        elif 'viewpurchase_id' in request.form:
            pid = int(request.form['viewpurchase_id'])
            cursor.execute("""
                SELECT s.id as id, s.invoice_no, s.sale_datetime, s.total_amount, COALESCE(SUM(si.quantity), 0) as item_count
                FROM sales s
                LEFT JOIN sales_items si ON s.id = si.sale_id
                WHERE s.patient_id = %s
                GROUP BY s.id, s.invoice_no, s.sale_datetime, s.total_amount
                ORDER BY s.sale_datetime DESC
            """, (pid,))
            sale_history = cursor.fetchall()
            show_history = True

        # Delete patient
        elif 'delpatient_id' in request.form:
            del_id = int(request.form.get('delpatient_id'))
            # Check for sales existence
            cursor.execute("SELECT COUNT(*) as count FROM sales WHERE patient_id=%s", (del_id,))
            sales_count = cursor.fetchone()['count']
            if sales_count > 0:
                # Show error, flash message, or handle gracefully (not deleting)
                flash("Cannot delete patient: sales records exist.", "danger")
            else:
                # Safe to delete
                cursor.execute("DELETE FROM patients WHERE id=%s", (del_id,))
                conn.commit()

        # Refresh list of patients after any operation
        cursor.execute("SELECT * FROM patients ORDER BY name;")
        patients = cursor.fetchall()

    cursor.close()
    conn.close()
    return render_template('patients.html', patients=patients, editing_patient=editing_patient,
                           show_history=show_history, sale_history=sale_history)

@app.route('/doctors', methods=['GET', 'POST'])
def doctors_view():
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)

    # Get all doctors
    cursor.execute("SELECT * FROM doctors ORDER BY name;")
    doctors = cursor.fetchall()

    editing_doctor = None
    show_history = False
    sale_history = []
    doctor_detail = None

    if request.method == 'POST':
        # Add new doctor
        if 'adddoctor' in request.form:
            name = request.form.get('name', '').strip()
            contact_number = request.form.get('contact_number', '').strip()
            address = request.form.get('address', '').strip()
            if name:
                cursor.execute("""
                    INSERT INTO doctors (name, contact_number, address)
                    VALUES (%s, %s, %s)
                """, (name, contact_number, address))
                conn.commit()
                flash("Doctor added successfully", "success")
        # Edit doctor
        elif 'editdoctor' in request.form:
            edit_id = int(request.form['editdoctor_id'])
            name = request.form.get('name', '').strip()
            contact_number = request.form.get('contact_number', '').strip()
            address = request.form.get('address', '').strip()
            cursor.execute("""
                UPDATE doctors SET name=%s, contact_number=%s, address=%s WHERE id=%s
            """, (name, contact_number, address, edit_id))
            conn.commit()
            flash("Doctor updated successfully", "success")
        # Start edit
        elif 'startedit_id' in request.form:
            edit_id = int(request.form['startedit_id'])
            cursor.execute("SELECT * FROM doctors WHERE id=%s", (edit_id,))
            editing_doctor = cursor.fetchone()

        # View sales history for doctor
        elif 'viewsales_id' in request.form:
            did = int(request.form['viewsales_id'])
            cursor.execute("SELECT * FROM doctors WHERE id=%s", (did,))
            doctor_detail = cursor.fetchone()
            show_history = True
            cursor.execute("""
                SELECT s.invoice_no, s.sale_datetime, p.name as patient_name, s.total_amount
                FROM sales s
                LEFT JOIN patients p ON s.patient_id = p.id
                WHERE s.doctor_id = %s
                ORDER BY s.sale_datetime DESC
            """, (did,))
            sale_history = cursor.fetchall()

        # Delete sale
        elif 'delsale_id' in request.form:
            del_id = int(request.form.get('delsale_id'))
            # Get the doctor_id from the sale
            cursor.execute("SELECT doctor_id FROM sales WHERE id=%s", (del_id,))
            sale = cursor.fetchone()
            if sale:
                doctor_id = sale['doctor_id']
                # First, get the items to restore stock
                cursor.execute("SELECT product_id, quantity FROM sales_items WHERE sale_id=%s", (del_id,))
                items_to_restore = cursor.fetchall()
                for item in items_to_restore:
                    cursor.execute("UPDATE medicines SET stock_qty = stock_qty + %s WHERE id = %s", (item['quantity'], item['product_id']))
                # Delete sales items and sale
                cursor.execute("DELETE FROM sales_items WHERE sale_id=%s", (del_id,))
                cursor.execute("DELETE FROM sales WHERE id=%s", (del_id,))
                conn.commit()
                # Refresh history for the doctor
                cursor.execute("SELECT * FROM doctors WHERE id=%s", (doctor_id,))
                doctor_detail = cursor.fetchone()
                show_history = True
                cursor.execute("""
                    SELECT s.invoice_no, s.sale_datetime, p.name as patient_name, s.total_amount
                    FROM sales s
                    LEFT JOIN patients p ON s.patient_id = p.id
                    WHERE s.doctor_id = %s
                    ORDER BY s.sale_datetime DESC
                """, (doctor_id,))
                sale_history = cursor.fetchall()
                return render_template('doctors.html', doctors=doctors, editing_doctor=editing_doctor,
                                       show_history=show_history, sale_history=sale_history, doctor_detail=doctor_detail)

        # Delete doctor (add your constraint checks as needed)
        elif 'deldoctor_id' in request.form:
            del_id = int(request.form.get('deldoctor_id'))
            try:
                # Check if doctor has sales
                cursor.execute("SELECT COUNT(*) as cnt FROM sales WHERE doctor_id=%s", (del_id,))
                if cursor.fetchone()['cnt'] > 0:
                    flash("Cannot delete doctor: sales records exist.", "danger")
                else:
                    cursor.execute("DELETE FROM doctors WHERE id=%s", (del_id,))
                    conn.commit()
            except Exception as e:
                pass

        # Refresh after any action
        cursor.execute("SELECT * FROM doctors ORDER BY name;")
        doctors = cursor.fetchall()

    cursor.close()
    conn.close()
    return render_template('doctors.html', doctors=doctors, editing_doctor=editing_doctor,
                           show_history=show_history, sale_history=sale_history, doctor_detail=doctor_detail)

@app.route('/bill/<int:sale_id>')
def bill_view(sale_id):
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("""
        SELECT s.*, p.name as patient_name, p.contact_number as patient_mobile,
               d.name as doctor_name, d.contact_number as doctor_mobile
        FROM sales s
        LEFT JOIN patients p ON s.patient_id = p.id
        LEFT JOIN doctors d ON s.doctor_id = d.id
        WHERE s.id = %s
    """, (sale_id,))
    sale = cursor.fetchone()
    # Fetch sales items along with medicine name to ensure `item.name` is available
    cursor.execute("""
        SELECT si.*, m.name
        FROM sales_items si
        LEFT JOIN medicines m ON si.product_id = m.id
        WHERE si.sale_id = %s
        ORDER BY si.id ASC
    """, (sale_id,))
    items = cursor.fetchall()
    cursor.close()
    conn.close()

    if not sale:
        return "Sale not found", 404

    # Initialize GST summary buckets
    gst_summary = {
        5:  {'gross': 0.0, 'taxable': 0.0, 'sgst': 0.0, 'cgst': 0.0, 'total_gst': 0.0},
        12: {'gross': 0.0, 'taxable': 0.0, 'sgst': 0.0, 'cgst': 0.0, 'total_gst': 0.0},
        'other': {'gross': 0.0, 'taxable': 0.0, 'sgst': 0.0, 'cgst': 0.0, 'total_gst': 0.0},
        'total': {'gross': 0.0, 'taxable': 0.0, 'sgst': 0.0, 'cgst': 0.0, 'total_gst': 0.0}
    }

    mrp_total = 0.0

    # Loop items and perform reverse tax calculations
    for item in items:
        try:
            qty = float(item.get('quantity', 0) or 0)
        except Exception:
            qty = 0.0
        try:
            rate = float(item.get('price', item.get('rate', 0)) or 0)
        except Exception:
            rate = 0.0
        try:
            mrp = float(item.get('mrp', 0) or 0)
        except Exception:
            mrp = 0.0
        try:
            sgst_p = float(item.get('sgst_percent', item.get('sgst', 0)) or 0)
        except Exception:
            sgst_p = 0.0
        try:
            cgst_p = float(item.get('cgst_percent', item.get('cgst', 0)) or 0)
        except Exception:
            cgst_p = 0.0

        gst_rate = sgst_p + cgst_p

        # Row Amount (Gross) = Rate * Qty
        row_gross = rate * qty

        # Accumulate MRP total as sum(mrp * qty)
        mrp_total += mrp * qty

        # Reverse calculation (inclusive tax -> taxable and tax amounts)
        if gst_rate > 0:
            taxable = row_gross / (1 + (gst_rate / 100))
            total_tax = row_gross - taxable
        else:
            taxable = row_gross
            total_tax = 0.0

        sgst_amt = total_tax / 2
        cgst_amt = total_tax / 2

        # Select bucket: exact 5 or 12, else 'other'
        if abs(gst_rate - 5.0) < 1e-9:
            bucket = 5
        elif abs(gst_rate - 12.0) < 1e-9:
            bucket = 12
        else:
            bucket = 'other'

        # Populate bucket
        gst_summary[bucket]['gross'] += row_gross
        gst_summary[bucket]['taxable'] += taxable
        gst_summary[bucket]['sgst'] += sgst_amt
        gst_summary[bucket]['cgst'] += cgst_amt
        gst_summary[bucket]['total_gst'] += total_tax

        # Add to totals
        gst_summary['total']['gross'] += row_gross
        gst_summary['total']['taxable'] += taxable
        gst_summary['total']['sgst'] += sgst_amt
        gst_summary['total']['cgst'] += cgst_amt
        gst_summary['total']['total_gst'] += total_tax

    # Final sale-level assignments
    sale['mrp_total'] = round(mrp_total, 2)
    sale['sub_total'] = round(gst_summary['total']['taxable'], 2)
    sale['total_amount'] = float(sale.get('total_amount', 0) or 0)
    sale['savings'] = round(sale['mrp_total'] - sale['total_amount'], 2)

    # Amount in words
    try:
        from num2words import num2words
        words = num2words(sale['total_amount'], lang='en_IN').title()
    except Exception:
        words = ''

    return render_template('bill.html', sale=sale, items=items, gst_summary=gst_summary, amount_in_words=words)

@app.route('/purchase_detail/<int:purchase_id>')
def purchase_detail_view(purchase_id):
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("""
        SELECT p.*, d.name as distributor_name, d.trade_type
        FROM purchases p
        LEFT JOIN distributors d ON p.distributor_id = d.id
        WHERE p.id = %s
    """, (purchase_id,))
    purchase = cursor.fetchone()
    if not purchase:
        return "Purchase not found", 404
    cursor.execute("""
        SELECT pi.*, COALESCE(m.name, 'Deleted Product') as name, m.packing
        FROM purchase_items pi
        LEFT JOIN medicines m ON pi.product_id = m.id
        WHERE pi.purchase_id = %s
    """, (purchase_id,))
    items = cursor.fetchall()

    cursor.close()
    conn.close()
    return render_template('purchase_detail.html', purchase=purchase, items=items, enumerate=enumerate)


@app.route('/debug/purchase_items/<int:purchase_id>')
def debug_purchase_items(purchase_id):
    """Development helper: return JSON of purchase_items for a purchase_id."""
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT pi.*, m.name as product_name FROM purchase_items pi LEFT JOIN medicines m ON pi.product_id = m.id WHERE pi.purchase_id = %s ORDER BY pi.sr_no", (purchase_id,))
    items = cursor.fetchall()
    cursor.close()
    conn.close()
    return jsonify({'purchase_id': purchase_id, 'count': len(items), 'items': items})


@app.route('/debug/purchase_items_counts')
def debug_purchase_items_counts():
    """Return a list of purchases with their purchase_items counts (for debugging)."""
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT p.id, p.invoice_no, COALESCE(cnt.cnt,0) as item_count FROM purchases p LEFT JOIN (SELECT purchase_id, COUNT(*) as cnt FROM purchase_items GROUP BY purchase_id) cnt ON cnt.purchase_id = p.id ORDER BY p.purchase_date DESC, p.id DESC")
    rows = cursor.fetchall()
    cursor.close()
    conn.close()
    return jsonify({'purchases': rows})

@app.route('/sales-return/<int:sales_return_id>')
def sales_return_bill_view(sales_return_id):
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("""
        SELECT sr.*, p.name as patient_name
        FROM sales_returns sr
        LEFT JOIN patients p ON sr.patient_id = p.id
        WHERE sr.id = %s
    """, (sales_return_id,))
    sales_return = cursor.fetchone()
    if not sales_return:
        return "Sales Return Bill not found", 404
    cursor.execute("""
        SELECT sri.*, m.name
        FROM sales_return_items sri
        JOIN medicines m ON sri.product_id = m.id
        WHERE sri.sales_return_id = %s
    """, (sales_return_id,))
    items = cursor.fetchall()

    # Calculate MRP total and savings
    mrp_total = sum((item['mrp'] or 0) * item['quantity'] for item in items)
    actual_total = sum(item['amount'] for item in items)
    savings = mrp_total - actual_total

    cursor.close()
    conn.close()
    return render_template('sales_return_bill.html', sales_return=sales_return, items=items, mrp_total=mrp_total, savings=savings, enumerate=enumerate)

@app.route('/purchase-return/<int:purchase_return_id>')
def purchase_return_bill_view(purchase_return_id):
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("""
        SELECT pr.*, d.name as distributor_name, d.trade_type
        FROM purchase_returns pr
        LEFT JOIN distributors d ON pr.distributor_id = d.id
        WHERE pr.id = %s
    """, (purchase_return_id,))
    purchase_return = cursor.fetchone()
    if not purchase_return:
        return "Purchase Return Bill not found", 404
    cursor.execute("""
        SELECT pri.*, m.name
        FROM purchase_return_items pri
        JOIN medicines m ON pri.product_id = m.id
        WHERE pri.purchase_return_id = %s
    """, (purchase_return_id,))
    items = cursor.fetchall()

    cursor.close()
    conn.close()
    return render_template('purchase_return_bill.html', purchase_return=purchase_return, items=items, enumerate=enumerate)

@app.route('/distributors', methods=['GET', 'POST'])
def distributors_view():
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)

    # Fetch all distributors
    cursor.execute("SELECT * FROM distributors ORDER BY name;")
    distributors = cursor.fetchall()

    editing_distributor = None
    show_history = False
    purchase_history = []
    distributor_detail = None

    if request.method == 'POST':
        # Add new distributor
        if 'adddistributor' in request.form:
            name = request.form.get('name', '').strip()
            contact_number = request.form.get('contact_number', '').strip()
            trade_type = request.form.get('trade_type', 'Retail')
            if name:
                cursor.execute("""
                    INSERT INTO distributors (name, contact_number, trade_type)
                    VALUES (%s, %s, %s)
                """, (name, contact_number, trade_type))
                conn.commit()
                flash("Distributor added successfully", "success")
        # Edit distributor
        elif 'editdistributor' in request.form:
            edit_id = int(request.form['editdistributor_id'])
            name = request.form.get('name', '').strip()
            contact_number = request.form.get('contact_number', '').strip()
            trade_type = request.form.get('trade_type', 'Retail')
            cursor.execute("""
                UPDATE distributors SET name=%s, contact_number=%s, trade_type=%s WHERE id=%s
            """, (name, contact_number, trade_type, edit_id))
            conn.commit()
            flash("Distributor updated successfully", "success")
        # Start edit
        elif 'startedit_id' in request.form:
            edit_id = int(request.form['startedit_id'])
            cursor.execute("SELECT * FROM distributors WHERE id=%s", (edit_id,))
            editing_distributor = cursor.fetchone()

        # View purchase history for distributor
        elif 'viewpurchases_id' in request.form:
            did = int(request.form['viewpurchases_id'])
            cursor.execute("SELECT * FROM distributors WHERE id=%s", (did,))
            distributor_detail = cursor.fetchone()
            show_history = True
            cursor.execute("""
                SELECT * FROM purchases
                WHERE distributor_id = %s
                ORDER BY purchase_date DESC
            """, (did,))
            purchase_history = cursor.fetchall()

        # Delete distributor (do not allow delete if linked purchases exist)
        elif 'deldistributor_id' in request.form:
            del_id = int(request.form.get('deldistributor_id'))
            try:
                cursor.execute("SELECT COUNT(*) AS cnt FROM purchases WHERE distributor_id=%s", (del_id,))
                if cursor.fetchone()['cnt'] > 0:
                    # Optional: flash a message
                    pass
                else:
                    cursor.execute("DELETE FROM distributors WHERE id=%s", (del_id,))
                    conn.commit()
            except Exception as e:
                pass

        # Refresh distributor list after any operation
        cursor.execute("SELECT * FROM distributors ORDER BY name;")
        distributors = cursor.fetchall()

    cursor.close()
    conn.close()
    return render_template('distributors.html', distributors=distributors, editing_distributor=editing_distributor,
                           show_history=show_history, purchase_history=purchase_history,
                           distributor_detail=distributor_detail)

# ---------- API Endpoints for Autofill ----------
@app.route('/api/medicine/<name>')
def get_medicine_details(name):
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT batch_no, packing, DATE_FORMAT(expiry_date, '%Y-%m-%d') as expiry_date, hsn_code, mrp, sgst_percent, cgst_percent, sale_rate, sale_discount_percent, purchase_rate FROM medicines WHERE name = %s ORDER BY expiry_date DESC", (name,))
    meds = cursor.fetchall()
    conn.close()
    return jsonify(meds)

@app.route('/api/distributor/<name>')
def get_distributor_details(name):
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT trade_type, contact_number FROM distributors WHERE name = %s", (name,))
    dist = cursor.fetchone()
    conn.close()
    return jsonify(dist or {})

@app.route('/api/patient/<name>')
def get_patient_details(name):
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT contact_number FROM patients WHERE name = %s", (name,))
    pat = cursor.fetchone()
    conn.close()
    return jsonify(pat or {})

@app.route('/api/doctor/<name>')
def get_doctor_details(name):
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT contact_number FROM doctors WHERE name = %s", (name,))
    doc = cursor.fetchone()
    conn.close()
    return jsonify(doc or {})

@app.route('/returns')
def returns_main():
    return render_template('returns.html')


@app.route('/sales-returns', methods=['GET', 'POST'])
def sales_returns_view():
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT * FROM patients ORDER BY name;")
    patients = cursor.fetchall()
    cursor.execute("SELECT * FROM distributors ORDER BY name;")
    distributors = cursor.fetchall()
    cursor.execute("SELECT * FROM medicines ORDER BY name;")
    medicines = cursor.fetchall()

    cursor.execute("""
        SELECT sr.id, sr.invoice_no, sr.return_datetime as return_datetime, p.name as patient_name,
               COALESCE(cnt.item_qty, 0) as item_count, sr.total_amount
        FROM sales_returns sr
        LEFT JOIN patients p ON sr.patient_id = p.id
        LEFT JOIN (
            SELECT sales_return_id, SUM(quantity) AS item_qty
            FROM sales_return_items
            GROUP BY sales_return_id
        ) cnt ON cnt.sales_return_id = sr.id
        ORDER BY sr.return_datetime DESC, sr.id DESC
    """)
    sales_returns_history = cursor.fetchall()

    cursor.execute("""
        SELECT pr.id, pr.invoice_no, pr.return_datetime as return_datetime, d.name as distributor_name,
               COALESCE(cnt.item_qty, 0) as item_count, pr.total_amount
        FROM purchase_returns pr
        LEFT JOIN distributors d ON pr.distributor_id = d.id
        LEFT JOIN (
            SELECT purchase_return_id, SUM(quantity) AS item_qty
            FROM purchase_return_items
            GROUP BY purchase_return_id
        ) cnt ON cnt.purchase_return_id = pr.id
        ORDER BY pr.return_datetime DESC, pr.id DESC
    """)
    purchase_returns_history = cursor.fetchall()

    def generate_return_invoice_no():
        today = datetime.datetime.now().strftime('%y%m%d')
        cursor.execute("SELECT MAX(CAST(RIGHT(invoice_no, 3) AS UNSIGNED)) as max_serial FROM sales_returns WHERE LEFT(invoice_no, 6) = %s", (today,))
        data = cursor.fetchone()
        serial = (data['max_serial'] + 1) if data and data['max_serial'] else 1
        return f"{today}{serial:03d}"

    sales_return_invoice_no = generate_return_invoice_no()
    sales_return_date = datetime.datetime.now().strftime('%Y-%m-%d')
    sales_rowcount = 1
    sales_items = [{}]
    sales_grand_total_mrp = sales_grand_total_actual = sales_savings_total = ''

    editing_sales_return = None
    edit_sales_return_id = None

    if request.method == 'POST':
        sales_rowcount = int(request.form.get('rowcount', 1))
        sales_return_date = request.form.get('return_date', '') or datetime.datetime.now().strftime('%Y-%m-%d')
        sales_return_invoice_no = request.form.get('invoice_no', sales_return_invoice_no)
        patient_name = request.form.get('patient_name', '').strip()
        grand_total_actual = request.form.get('grand_total_actual', '').strip()
        grand_total_mrp = request.form.get('grand_total_mrp', '').strip()
        savings_total = request.form.get('savings_total', '').strip()

        edit_sales_return_id = request.form.get('edit_sales_return_id')
        # Start editing sales return
        if 'startedit_salesreturn_id' in request.form:
            edit_id = int(request.form.get('startedit_salesreturn_id'))
            cursor.execute("""
                SELECT sr.*, p.name as patient_name
                FROM sales_returns sr
                LEFT JOIN patients p ON sr.patient_id = p.id
                WHERE sr.id = %s
            """, (edit_id,))
            editing_sales_return = cursor.fetchone()
            cursor.execute("""
                SELECT sri.*, m.name as product FROM sales_return_items sri
                JOIN medicines m ON sri.product_id = m.id
                WHERE sri.sales_return_id = %s
            """, (edit_id,))
            item_list = cursor.fetchall()
            sales_items = []
            for item in item_list:
                gst_percent = (item['sgst_percent'] or 0) + (item['cgst_percent'] or 0)
                sales_items.append({
                    'product': item['product'],
                    'batch_no': item['batch_no'],
                    'expiry_date': item['expiry_date'],
                    'hsn_code': item['hsn_code'],
                    'mrp': item['mrp'],
                    'quantity': item['quantity'],
                    'rate': item['price'],
                    'gst_percent': gst_percent,
                    'discount_percent': item['discount_percent'],
                    'amount': item['amount'],
                })
            sales_rowcount = len(sales_items) if sales_items else 1
            return render_template('sale_returns.html', patients=patients, sales_rowcount=sales_rowcount, sales_items=sales_items,
                                   sales_grand_total_actual=editing_sales_return['total_amount'], sales_grand_total_mrp='', sales_savings_total='',
                                   sales_returns_history=sales_returns_history, purchase_rowcount=1, purchase_items=[{}],
                                   purchase_returns_history=purchase_returns_history, distributors=distributors, medicines=medicines,
                                   editing_sales_return=editing_sales_return, edit_sales_return_id=edit_id,
                                   sales_return_invoice_no=editing_sales_return['invoice_no'],
                                   sales_return_date=editing_sales_return['return_datetime'].strftime('%Y-%m-%d'), patient_name=editing_sales_return['patient_name'])

        # Handle delete sales return record
        if 'delsalesreturn_id' in request.form:
            del_id = int(request.form.get('delsalesreturn_id'))
            # Get items to revert stock
            cursor.execute("SELECT product_id, quantity FROM sales_return_items WHERE sales_return_id=%s", (del_id,))
            items_to_revert = cursor.fetchall()
            for item in items_to_revert:
                # Reduce stock_qty by quantity (removing the returned stock)
                cursor.execute("UPDATE medicines SET stock_qty = stock_qty - %s WHERE id = %s", (item['quantity'], item['product_id']))
            cursor.execute("DELETE FROM sales_return_items WHERE sales_return_id=%s", (del_id,))
            cursor.execute("DELETE FROM sales_returns WHERE id=%s", (del_id,))
            conn.commit()
            return redirect(url_for('sales_returns_view'))

        # Add row to form
        if 'addrow' in request.form:
            sales_items = [
                {
                    'product': request.form.get(f'items-{i}-product', ''),
                    'batch_no': request.form.get(f'items-{i}-batch_no', ''),
                    'expiry_date': request.form.get(f'items-{i}-expiry_date', ''),
                    'hsn_code': request.form.get(f'items-{i}-hsn_code', ''),
                    'mrp': request.form.get(f'items-{i}-mrp', ''),
                    'quantity': request.form.get(f'items-{i}-quantity', ''),
                    'rate': request.form.get(f'items-{i}-rate', ''),
                    'sgst_percent': request.form.get(f'items-{i}-sgst_percent', ''),
                    'cgst_percent': request.form.get(f'items-{i}-cgst_percent', ''),
                    'amount': request.form.get(f'items-{i}-amount', ''),
                }
                for i in range(sales_rowcount)
            ]
            sales_rowcount += 1
            sales_items.append({})
            flash("Row added", "info")

        # Delete row from form
        if 'delrow' in request.form:
            del_idx = int(request.form['delrow'])
            sales_items = [
                {
                    'product': request.form.get(f'items-{i}-product', ''),
                    'batch_no': request.form.get(f'items-{i}-batch_no', ''),
                    'expiry_date': request.form.get(f'items-{i}-expiry_date', ''),
                    'hsn_code': request.form.get(f'items-{i}-hsn_code', ''),
                    'mrp': request.form.get(f'items-{i}-mrp', ''),
                    'quantity': request.form.get(f'items-{i}-quantity', ''),
                    'rate': request.form.get(f'items-{i}-rate', ''),
                    'sgst_percent': request.form.get(f'items-{i}-sgst_percent', ''),
                    'cgst_percent': request.form.get(f'items-{i}-cgst_percent', ''),
                    'amount': request.form.get(f'items-{i}-amount', ''),
                }
                for i in range(sales_rowcount) if i != del_idx
            ]
            sales_rowcount = max(1, len(sales_items))
            flash("Row deleted", "info")

        # Save sales return
        if 'savesalesreturn' in request.form:
            errors = []
            if not patient_name:
                errors.append("Patient name is required.")
            if sales_rowcount == 0:
                errors.append("At least one returned item is required.")
            valid_items = 0
            for i in range(sales_rowcount):
                prod_name = request.form.get(f'items-{i}-product', '').strip()
                qty = request.form.get(f'items-{i}-quantity', '').strip()
                rate = request.form.get(f'items-{i}-rate', '').strip()
                if prod_name and qty and rate:
                    try:
                        qty_val = int(qty)
                        rate_val = float(rate)
                        if qty_val <= 0 or rate_val <= 0:
                            errors.append(f"Item {i+1}: Quantity and rate must be positive.")
                        else:
                            valid_items += 1
                    except ValueError:
                        errors.append(f"Item {i+1}: Invalid quantity or rate.")
                elif prod_name or qty or rate:
                    errors.append(f"Item {i+1}: Incomplete item data.")
            if valid_items == 0:
                errors.append("At least one complete returned item is required.")
            if not grand_total_actual:
                errors.append("Grand total is required.")

            print(f"DEBUG: errors: {errors}")
            print(f"DEBUG: patient_name: {patient_name}, sales_rowcount: {sales_rowcount}, valid_items: {valid_items}, grand_total_actual: {grand_total_actual}")

            if errors:
                for error in errors:
                    flash(error, "danger")
                sales_items = [
                    {
                        'product': request.form.get(f'items-{i}-product', ''),
                        'batch_no': request.form.get(f'items-{i}-batch_no', ''),
                        'expiry_date': request.form.get(f'items-{i}-expiry_date', ''),
                        'hsn_code': request.form.get(f'items-{i}-hsn_code', ''),
                        'mrp': request.form.get(f'items-{i}-mrp', ''),
                        'quantity': request.form.get(f'items-{i}-quantity', ''),
                        'rate': request.form.get(f'items-{i}-rate', ''),
                        'sgst_percent': request.form.get(f'items-{i}-sgst_percent', ''),
                        'cgst_percent': request.form.get(f'items-{i}-cgst_percent', ''),
                        'amount': request.form.get(f'items-{i}-amount', ''),
                    }
                    for i in range(sales_rowcount)
                ]
                sales_grand_total_actual = grand_total_actual
                sales_grand_total_mrp = grand_total_mrp
                sales_savings_total = savings_total
                return render_template('sale_returns.html', patients=patients, sales_rowcount=sales_rowcount, sales_items=sales_items,
                                       sales_grand_total_actual=sales_grand_total_actual, sales_grand_total_mrp=sales_grand_total_mrp,
                                       sales_savings_total=sales_savings_total, sales_returns_history=sales_returns_history,
                                       purchase_rowcount=1, purchase_items=[{}], purchase_returns_history=[],
                                       distributors=[], medicines=[])

            try:
                # Patient ID resolution or insertion if new
                patient_id = None
                for p in patients:
                    if p['name'].strip().lower() == patient_name.lower():
                        patient_id = p['id']
                        break
                if not patient_id and patient_name:
                    cursor.execute("INSERT INTO patients (name) VALUES (%s)", (patient_name,))
                    cursor.execute("INSERT INTO patients (name, contact_number) VALUES (%s, %s)", (patient_name, ''))
                    patient_id = cursor.lastrowid

                # Insert sales return record
                return_datetime = datetime.datetime.now()

                if edit_sales_return_id:
                    # This is an update
                    sales_return_id = int(edit_sales_return_id)
                    # Revert stock for old items
                    cursor.execute("SELECT product_id, quantity FROM sales_return_items WHERE sales_return_id=%s", (sales_return_id,))
                    items_to_revert = cursor.fetchall()
                    for item in items_to_revert:
                        cursor.execute("UPDATE medicines SET stock_qty = stock_qty - %s WHERE id = %s", (item['quantity'], item['product_id']))
                    
                    # Delete old items
                    cursor.execute("DELETE FROM sales_return_items WHERE sales_return_id=%s", (sales_return_id,))

                    # Update sales return header
                    cursor.execute("""
                        UPDATE sales_returns SET patient_id=%s, invoice_no=%s, return_datetime=%s, total_amount=%s
                        WHERE id=%s
                    """, (patient_id, sales_return_invoice_no, sales_return_date, float(grand_total_actual), sales_return_id))
                else:
                    # This is a new sales return
                    cursor.execute("""
                    INSERT INTO sales_returns (patient_id, invoice_no, return_datetime, total_amount)
                    VALUES (%s, %s, %s, %s)
                """, (patient_id, sales_return_invoice_no, return_datetime, float(grand_total_actual)))
                sales_return_id = cursor.lastrowid

                for i in range(sales_rowcount):
                    prod_name = request.form.get(f'items-{i}-product', '').strip()
                    if not prod_name:
                        continue
                    batch_no = request.form.get(f'items-{i}-batch_no', '')
                    expiry_date = request.form.get(f'items-{i}-expiry_date', None)
                    hsn_code = request.form.get(f'items-{i}-hsn_code', '')
                    mrp_str = request.form.get(f'items-{i}-mrp', '').strip()
                    mrp = float(mrp_str) if mrp_str else 0.0
                    qty_str = request.form.get(f'items-{i}-quantity', '').strip()
                    qty = int(qty_str) if qty_str else 0
                    rate_str = request.form.get(f'items-{i}-rate', '').strip()
                    rate = float(rate_str) if rate_str else 0.0
                    sgst_str = request.form.get(f'items-{i}-sgst_percent', '').strip()
                    sgst = float(sgst_str) if sgst_str else 0.0
                    cgst_str = request.form.get(f'items-{i}-cgst_percent', '').strip()
                    cgst = float(cgst_str) if cgst_str else 0.0
                    dis_str = request.form.get(f'items-{i}-discount_percent', '').strip()
                    dis = float(dis_str) if dis_str else 0.0

                    amount_input = request.form.get(f'items-{i}-amount', '').strip()
                    if amount_input:
                        amount = float(amount_input)
                    else:
                        base = qty * rate
                        discount_amt = base * dis / 100
                        amount = base - discount_amt

                    medicine_id = None
                    for m in medicines:
                        if m['name'].strip().lower() == prod_name.lower() and m['batch_no'] == batch_no and str(m['expiry_date']) == str(expiry_date):
                            medicine_id = m['id']

                    if not medicine_id and prod_name:
                        cursor.execute("""
                            INSERT INTO medicines (name, batch_no, expiry_date, hsn_code, mrp, sgst_percent, cgst_percent, stock_qty)
                            VALUES (%s,%s,%s,%s,%s,%s,%s,%s)
                        """, (prod_name, batch_no, expiry_date, hsn_code, mrp, sgst, cgst, 0))
                        medicine_id = cursor.lastrowid

                    if medicine_id:
                        # On sales return, add stock_qty by qty (returns increase stock)
                        cursor.execute("UPDATE medicines SET stock_qty = stock_qty + %s WHERE id = %s", (qty, medicine_id))

                    cursor.execute("""
                        INSERT INTO sales_return_items (sales_return_id, product_id, quantity, price, amount, batch_no, expiry_date, hsn_code, mrp, sgst_percent, cgst_percent, discount_percent)
                        VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)
                    """, (sales_return_id, medicine_id, qty, rate, amount, batch_no, expiry_date, hsn_code, mrp, sgst, cgst, dis))

                conn.commit()
                flash("Sales return saved successfully", "success")
                if edit_sales_return_id:
                    flash("Sales return updated successfully", "success")
                else:
                    flash("Sales return saved successfully", "success")
                return redirect(url_for('sales_returns_view'))
            except Exception as e:
                flash(f"Error saving sales return: {str(e)}", "danger")
                # Re-render with current data
                sales_items = [
                    {
                        'product': request.form.get(f'items-{i}-product', ''),
                        'batch_no': request.form.get(f'items-{i}-batch_no', ''),
                        'expiry_date': request.form.get(f'items-{i}-expiry_date', ''),
                        'hsn_code': request.form.get(f'items-{i}-hsn_code', ''),
                        'mrp': request.form.get(f'items-{i}-mrp', ''),
                        'quantity': request.form.get(f'items-{i}-quantity', ''),
                        'rate': request.form.get(f'items-{i}-rate', ''),
                        'sgst_percent': request.form.get(f'items-{i}-sgst_percent', ''),
                        'cgst_percent': request.form.get(f'items-{i}-cgst_percent', ''),
                        'amount': request.form.get(f'items-{i}-amount', ''),
                    }
                    for i in range(sales_rowcount)
                ]
                return render_template('sale_returns.html', patients=patients, sales_rowcount=sales_rowcount, sales_items=sales_items,
                                       sales_grand_total_actual=grand_total_actual, sales_grand_total_mrp=grand_total_mrp,
                                       sales_savings_total=savings_total, sales_returns_history=sales_returns_history,
                                       purchase_rowcount=1, purchase_items=[{}], purchase_returns_history=purchase_returns_history,
                                       distributors=distributors, medicines=medicines)
            finally:
                cursor.close()
                conn.close()

    if not sales_items:
        sales_items = [{}]

    return render_template('sale_returns.html', patients=patients, sales_rowcount=sales_rowcount, sales_items=sales_items,
                           sales_grand_total_actual=sales_grand_total_actual, sales_grand_total_mrp=sales_grand_total_mrp,
                           sales_savings_total=sales_savings_total, sales_returns_history=sales_returns_history,
                           purchase_rowcount=1, purchase_items=[{}], purchase_returns_history=purchase_returns_history,
                           distributors=distributors, medicines=medicines)


@app.route('/purchase-returns', methods=['GET', 'POST'])
def purchase_returns_view():
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT * FROM distributors ORDER BY name;")
    distributors = cursor.fetchall()
    cursor.execute("SELECT * FROM medicines ORDER BY name;")
    medicines = cursor.fetchall()

    cursor.execute("""
        SELECT pr.id, pr.invoice_no, pr.return_datetime as return_datetime, d.name as distributor_name, 
               COALESCE(cnt.item_qty, 0) as item_count, pr.total_amount
        FROM purchase_returns pr
        LEFT JOIN distributors d ON pr.distributor_id = d.id
        LEFT JOIN (
            SELECT purchase_return_id, SUM(quantity) AS item_qty
            FROM purchase_return_items
            GROUP BY purchase_return_id
        ) cnt ON cnt.purchase_return_id = pr.id
        ORDER BY pr.return_datetime DESC, pr.id DESC
    """)
    purchase_returns_history = cursor.fetchall()

    def generate_return_invoice_no():
        today = datetime.datetime.now().strftime('%y%m%d')
        cursor.execute("SELECT MAX(CAST(RIGHT(invoice_no, 3) AS UNSIGNED)) as max_serial FROM purchase_returns WHERE LEFT(invoice_no, 6) = %s", (today,))
        data = cursor.fetchone()
        serial = (data['max_serial'] + 1) if data and data['max_serial'] else 1
        return f"{today}{serial:03d}"

    purchase_return_invoice_no = generate_return_invoice_no()
    purchase_return_date = datetime.datetime.now().strftime('%Y-%m-%d')
    purchase_rowcount = 1
    purchase_items = [{}]
    purchase_grand_total = ''

    editing_purchase_return = None
    edit_purchase_return_id = None

    if request.method == 'POST':
        purchase_rowcount = int(request.form.get('rowcount', 1))
        purchase_return_date = request.form.get('return_date', '') or datetime.datetime.now().strftime('%Y-%m-%d')
        purchase_return_invoice_no = request.form.get('invoice_no', purchase_return_invoice_no)
        distributor_name = request.form.get('distributor_name', '').strip()
        distributor_contact = request.form.get('distributor_contact', '').strip()
        grand_total = request.form.get('grand_total', '').strip()
        edit_purchase_return_id = request.form.get('edit_purchase_return_id')

        # Start editing purchase return
        if 'startedit_purchasereturn_id' in request.form:
            edit_id = int(request.form.get('startedit_purchasereturn_id'))
            cursor.execute("""
                SELECT pr.*, d.name as distributor_name
                FROM purchase_returns pr
                LEFT JOIN distributors d ON pr.distributor_id = d.id
                WHERE pr.id = %s
            """, (edit_id,))
            editing_purchase_return = cursor.fetchone()
            cursor.execute("""
                SELECT pri.*, m.name as product FROM purchase_return_items pri
                JOIN medicines m ON pri.product_id = m.id
                WHERE pri.purchase_return_id = %s
            """, (edit_id,))
            item_list = cursor.fetchall()
            purchase_items = []
            for item in item_list:
                purchase_items.append({
                    'product': item['product'],
                    'batch_no': item['batch_no'],
                    'expiry_date': item['expiry_date'],
                    'quantity': item['quantity'],
                    'rate': item['price'],
                    'amount': item['amount'],
                })
            purchase_rowcount = len(purchase_items) if purchase_items else 1
            return render_template('purchase_returns.html', distributors=distributors, purchase_rowcount=purchase_rowcount, purchase_items=purchase_items,
                                   purchase_grand_total=editing_purchase_return['total_amount'], purchase_returns_history=purchase_returns_history,
                                   medicines=medicines, editing_purchase_return=editing_purchase_return, edit_purchase_return_id=edit_id)

        # Handle delete purchase return record
        if 'delpurchasereturn_id' in request.form:
            del_id = int(request.form.get('delpurchasereturn_id'))
            # Get items to revert stock (include free units)
            cursor.execute("SELECT product_id, quantity, `free` FROM purchase_return_items WHERE purchase_return_id=%s", (del_id,))
            items_to_revert = cursor.fetchall()
            for item in items_to_revert:
                revert_qty = int(item.get('quantity') or 0) + int(item.get('free') or 0)
                # Increase stock_qty by quantity + free (revert stock removal)
                cursor.execute("UPDATE medicines SET stock_qty = stock_qty + %s WHERE id = %s", (revert_qty, item['product_id']))
            cursor.execute("DELETE FROM purchase_return_items WHERE purchase_return_id=%s", (del_id,))
            cursor.execute("DELETE FROM purchase_returns WHERE id=%s", (del_id,))
            conn.commit()
            return redirect(url_for('purchase_returns_view'))

        # Add row to form
        if 'addrow' in request.form:
            purchase_items = [
                {
                    'product': request.form.get(f'items-{i}-product', ''),
                    'batch_no': request.form.get(f'items-{i}-batch_no', ''),
                    'expiry_date': request.form.get(f'items-{i}-expiry_date', ''),
                    'hsn_code': request.form.get(f'items-{i}-hsn_code', ''),
                    'mrp': request.form.get(f'items-{i}-mrp', ''),
                    'quantity': request.form.get(f'items-{i}-quantity', ''),
                    'rate': request.form.get(f'items-{i}-rate', ''),
                    'sale_discount_percent': request.form.get(f'items-{i}-sale_discount_percent', ''),
                    'sale_rate': request.form.get(f'items-{i}-sale_rate', ''),
                    'sgst_percent': request.form.get(f'items-{i}-sgst_percent', ''),
                    'cgst_percent': request.form.get(f'items-{i}-cgst_percent', ''),
                    'amount': request.form.get(f'items-{i}-amount', ''),
                }
                for i in range(purchase_rowcount)
            ]
            purchase_rowcount += 1
            purchase_items.append({})
            flash("Row added", "info")

        # Delete row from form
        if 'delrow' in request.form:
            del_idx = int(request.form['delrow'])
            purchase_items = [
                {
                    'product': request.form.get(f'items-{i}-product', ''),
                    'batch_no': request.form.get(f'items-{i}-batch_no', ''),
                    'expiry_date': request.form.get(f'items-{i}-expiry_date', ''),
                    'hsn_code': request.form.get(f'items-{i}-hsn_code', ''),
                    'mrp': request.form.get(f'items-{i}-mrp', ''),
                    'quantity': request.form.get(f'items-{i}-quantity', ''),
                    'rate': request.form.get(f'items-{i}-rate', ''),
                    'sale_discount_percent': request.form.get(f'items-{i}-sale_discount_percent', ''),
                    'sale_rate': request.form.get(f'items-{i}-sale_rate', ''),
                    'sgst_percent': request.form.get(f'items-{i}-sgst_percent', ''),
                    'cgst_percent': request.form.get(f'items-{i}-cgst_percent', ''),
                    'amount': request.form.get(f'items-{i}-amount', ''),
                }
                for i in range(purchase_rowcount) if i != del_idx
            ]
            purchase_rowcount = max(1, len(purchase_items))
            flash("Row deleted", "info")

        # Save purchase return
        if 'savepurchasereturn' in request.form:
            errors = []
            if not distributor_name:
                errors.append("Distributor name is required.")
            if purchase_rowcount == 0:
                errors.append("At least one returned item is required.")
            valid_items = 0
            for i in range(purchase_rowcount):
                prod_name = request.form.get(f'items-{i}-product', '').strip()
                qty = request.form.get(f'items-{i}-quantity', '').strip()
                rate = request.form.get(f'items-{i}-rate', '').strip()
                if prod_name and qty and rate:
                    try:
                        qty_val = int(qty)
                        rate_val = float(rate)
                        if qty_val <= 0 or rate_val <= 0:
                            errors.append(f"Item {i+1}: Quantity and rate must be positive.")
                        else:
                            valid_items += 1
                    except ValueError:
                        errors.append(f"Item {i+1}: Invalid quantity or rate.")
                elif prod_name or qty or rate:
                    errors.append(f"Item {i+1}: Incomplete item data.")
            if valid_items == 0:
                errors.append("At least one complete returned item is required.")
            if not grand_total:
                errors.append("Grand total is required.")

            invoice_no = request.form.get('invoice_no') or generate_return_invoice_no()
            # Check for duplicate invoice_no
            cursor.execute("SELECT COUNT(*) as count FROM purchase_returns WHERE invoice_no = %s", (invoice_no,))
            if cursor.fetchone()['count'] > 0:
                errors.append("Invoice number already exists. Please try again.")

            if errors:
                for error in errors:
                    flash(error, "danger")
                purchase_grand_total = grand_total
                return render_template('purchase_returns.html', distributors=distributors, purchase_rowcount=purchase_rowcount,
                                       purchase_items=purchase_items, purchase_grand_total=purchase_grand_total,
                                       purchase_returns_history=purchase_returns_history,
                                       sales_rowcount=1, sales_items=[{}], sales_returns_history=[],
                                       patients=[], medicines=[])

            try:
                # Distributor ID resolution or insert new distributor
                distributor_id = None
                for d in distributors:
                    if d['name'].strip().lower() == distributor_name.lower():
                        distributor_id = d['id']
                        break
                if not distributor_id and distributor_name:
                    cursor.execute("INSERT INTO distributors (name) VALUES (%s)", (distributor_name,))
                    distributor_id = cursor.lastrowid
                return_datetime = datetime.datetime.now()

                if edit_purchase_return_id:
                    # This is an update
                    purchase_return_id = int(edit_purchase_return_id)
                    # Revert stock for old items
                    cursor.execute("SELECT product_id, quantity, `free` FROM purchase_return_items WHERE purchase_return_id=%s", (purchase_return_id,))
                    items_to_revert = cursor.fetchall()
                    for item in items_to_revert:
                        revert_qty = int(item.get('quantity') or 0) + int(item.get('free') or 0)
                        cursor.execute("UPDATE medicines SET stock_qty = stock_qty + %s WHERE id = %s", (revert_qty, item['product_id']))
                    
                    # Delete old items
                    cursor.execute("DELETE FROM purchase_return_items WHERE purchase_return_id=%s", (purchase_return_id,))

                    # Update purchase return header
                    cursor.execute("""
                        UPDATE purchase_returns SET distributor_id=%s, invoice_no=%s, return_datetime=%s, total_amount=%s
                        WHERE id=%s
                    """, (distributor_id, purchase_return_invoice_no, purchase_return_date, float(grand_total), purchase_return_id))
                else:
                    # This is a new purchase return
                    return_datetime = datetime.datetime.now()
                    cursor.execute("""
                    INSERT INTO purchase_returns (distributor_id, invoice_no, return_datetime, total_amount)
                    VALUES (%s, %s, %s, %s)
                """, (distributor_id, purchase_return_invoice_no, return_datetime, float(grand_total)))
                purchase_return_id = cursor.lastrowid
                for i in range(purchase_rowcount):
                    prod_name = request.form.get(f'items-{i}-product', '').strip()
                    if not prod_name:
                        continue
                    batch_no = request.form.get(f'items-{i}-batch_no', '')
                    expiry_date = request.form.get(f'items-{i}-expiry_date', None)
                    packing = request.form.get(f'items-{i}-packing', '')
                    hsn_code = request.form.get(f'items-{i}-hsn_code', '')
                    mrp_str = request.form.get(f'items-{i}-mrp', '').strip()
                    mrp = float(mrp_str) if mrp_str else 0.0
                    qty_str = request.form.get(f'items-{i}-quantity', '').strip()
                    qty = int(qty_str) if qty_str else 0
                    free_str = request.form.get(f'items-{i}-free', '').strip()
                    free = int(free_str) if free_str else 0
                    rate_str = request.form.get(f'items-{i}-rate', '').strip()
                    rate = float(rate_str) if rate_str else 0.0
                    sgst_str = request.form.get(f'items-{i}-sgst_percent', '').strip()
                    sgst = float(sgst_str) if sgst_str else 0.0
                    cgst_str = request.form.get(f'items-{i}-cgst_percent', '').strip()
                    cgst = float(cgst_str) if cgst_str else 0.0
                    dis_str = request.form.get(f'items-{i}-discount_percent', '').strip()
                    dis = float(dis_str) if dis_str else 0.0
                    amount_input = request.form.get(f'items-{i}-amount', '').strip()
                    if amount_input:
                        amount = float(amount_input)
                    else:
                        base = qty * rate
                        discount_amt = base * dis / 100
                        amount = base - discount_amt
                    medicine_id = None
                    for m in medicines:
                        if m['name'].strip().lower() == prod_name.lower() and m['batch_no'] == batch_no and str(m['expiry_date']) == str(expiry_date) and str(m.get('packing') or '') == str(packing or ''):
                            medicine_id = m['id']
                    if not medicine_id and prod_name:
                        cursor.execute("""
                            INSERT INTO medicines (name, batch_no, expiry_date, hsn_code, mrp, sgst_percent, cgst_percent, stock_qty, packing)
                            VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s)
                        """, (prod_name, batch_no, expiry_date, hsn_code, mrp, sgst, cgst, 0))
                        medicine_id = cursor.lastrowid
                    if medicine_id:
                        # On purchase return, reduce stock_qty by qty + free (returned items include free units)
                        cursor.execute("UPDATE medicines SET stock_qty = stock_qty - %s WHERE id = %s", (qty + free, medicine_id))
                    cursor.execute("""
                        INSERT INTO purchase_return_items (purchase_return_id, product_id, quantity, `free`, price, amount, batch_no, expiry_date, hsn_code, mrp, sgst_percent, cgst_percent, discount_percent)
                        VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)
                    """, (purchase_return_id, medicine_id, qty, free, rate, amount, batch_no, expiry_date, hsn_code, mrp, sgst, cgst, dis))
                conn.commit()
                flash("Purchase return saved successfully", "success")
                if edit_purchase_return_id:
                    flash("Purchase return updated successfully", "success")
                else:
                    flash("Purchase return saved successfully", "success")
                return redirect(url_for('purchase_returns_view'))
            except Exception as e:
                flash(f"Error saving purchase return: {str(e)}", "danger")
                # Re-render with current data
                purchase_items = [
                    {
                        'product': request.form.get(f'items-{i}-product', ''),
                        'batch_no': request.form.get(f'items-{i}-batch_no', ''),
                        'expiry_date': request.form.get(f'items-{i}-expiry_date', ''),
                        'hsn_code': request.form.get(f'items-{i}-hsn_code', ''),
                        'mrp': request.form.get(f'items-{i}-mrp', ''),
                        'quantity': request.form.get(f'items-{i}-quantity', ''),
                        'rate': request.form.get(f'items-{i}-rate', ''),
                        'sale_discount_percent': request.form.get(f'items-{i}-sale_discount_percent', ''),
                        'sale_rate': request.form.get(f'items-{i}-sale_rate', ''),
                        'sgst_percent': request.form.get(f'items-{i}-sgst_percent', ''),
                        'cgst_percent': request.form.get(f'items-{i}-cgst_percent', ''),
                        'amount': request.form.get(f'items-{i}-amount', ''),
                    }
                    for i in range(purchase_rowcount)
                ]
                return render_template('purchase_returns.html', distributors=distributors, purchase_rowcount=purchase_rowcount, purchase_items=purchase_items,
                                       purchase_grand_total=grand_total, purchase_returns_history=purchase_returns_history,
                                       sales_rowcount=1, sales_items=[{}], sales_returns_history=[],
                                       patients=[], medicines=[])
            finally:
                cursor.close()
                conn.close()

    cursor.close()
    conn.close()

    if not purchase_items:
        purchase_items = [{}]

    return render_template('purchase_returns.html', distributors=distributors, purchase_rowcount=purchase_rowcount, purchase_items=purchase_items,
                           purchase_grand_total=purchase_grand_total, purchase_returns_history=purchase_returns_history,
                           sales_rowcount=1, sales_items=[{}], sales_returns_history=[],
                           patients=[], medicines=medicines, editing_purchase_return=editing_purchase_return,
                           edit_purchase_return_id=edit_purchase_return_id)

import webbrowser
from threading import Timer
from multiprocessing import freeze_support

# Prefer waitress if available, otherwise fall back to Flask's built-in server
try:
    from waitress import serve  # type: ignore
    _HAS_WAITRESS = True
except Exception:
    _HAS_WAITRESS = False

def open_browser():
    webbrowser.open_new('http://127.0.0.1:5000/')

if __name__ == "__main__":
    # freeze_support() is required for multiprocessing to work in a frozen app
    freeze_support()
    Timer(1, open_browser).start()
    if _HAS_WAITRESS:
        # Use a production-ready WSGI server if available
        serve(app, host='127.0.0.1', port=5000)
    else:
        # Fallback: use Flask's development server
        app.run(host='127.0.0.1', port=5000)