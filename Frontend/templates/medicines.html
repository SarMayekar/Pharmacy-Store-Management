{% extends "base.html" %}
{% block content %}
<h2>Medicines Inventory</h2>

<form method="post" class="mb-4">
  {% if editing_medicine %}
    <input type="hidden" name="edit_medicine_id" value="{{ editing_medicine.id }}">
  {% endif %}
  <div class="row g-2">
    <div class="col"><input type="text" class="form-control" name="name" placeholder="Name" required value="{{ editing_medicine.name if editing_medicine else '' }}"></div>
    <div class="col"><input type="text" class="form-control" name="packing" placeholder="Packing" value="{{ editing_medicine.packing if editing_medicine else '' }}"></div>
    <div class="col"><input type="text" class="form-control" name="hsn_code" placeholder="HSN" value="{{ editing_medicine.hsn_code if editing_medicine else '' }}"></div>
    <div class="col"><input type="text" class="form-control" name="batch_no" placeholder="Batch" value="{{ editing_medicine.batch_no if editing_medicine else '' }}"></div>
    <div class="col"><input type="date" class="form-control" name="expiry_date" placeholder="Expiry" value="{{ editing_medicine.expiry_date if editing_medicine else '' }}"></div>
    <div class="col"><input type="number" step="0.01" class="form-control" name="mrp" placeholder="MRP" value="{{ editing_medicine.mrp if editing_medicine else '' }}"></div>
    <div class="col"><input type="number" step="0.01" class="form-control" name="price" placeholder="Sale Rate" value="{{ editing_medicine.sale_rate if editing_medicine else '' }}"></div>
    <div class="col"><input type="number" step="0.01" class="form-control" name="purchase_price" placeholder="Purchase Rate" value="{{ editing_medicine.purchase_rate if editing_medicine else '' }}"></div>
    <div class="col"><input type="number" step="1" class="form-control" name="stock_qty" placeholder="Qty" value="{{ editing_medicine.stock_qty if editing_medicine else '' }}"></div>
    <div class="col"><input type="number" step="0.01" class="form-control" name="gst_percent" placeholder="GST %" value="{{ (editing_medicine.sgst_percent|default(0)|float + editing_medicine.cgst_percent|default(0)|float) if editing_medicine else '' }}"></div>
    <div class="col"><button type="submit" name="addmedicine" value="1" class="btn btn-success w-100" onclick="return validateForm()">{{ 'Update Medicine' if editing_medicine else 'Add' }}</button></div>
  </div>
</form>
{% if editing_medicine %}
<a href="{{ url_for('medicines_view') }}" class="btn btn-secondary mt-2">Cancel Edit</a>
{% endif %}

<table class="table table-bordered table-striped text-center" id="medicines-table">
  <thead>
    <tr>
      <th>ID</th><th>Name</th><th>Packing</th><th>HSN</th><th>Batch</th><th>Expiry</th>
      <th>MRP</th><th>Sale&nbsp;Rate</th><th>Purchase&nbsp;Rate</th><th>Qty</th>
      <th>GST%</th>
      <th>Edit</th><th>Sales</th><th>Purchases</th><th>Delete</th>
    </tr>
    <tr class="filter-row">
      <th><input type="number" class="form-control filter-input" data-column="0" placeholder="Filter ID"></th>
      <th><input type="text" class="form-control filter-input" data-column="1" placeholder="Filter Name"></th>
      <th><input type="text" class="form-control filter-input" data-column="2" placeholder="Filter Packing"></th>
      <th><input type="text" class="form-control filter-input" data-column="3" placeholder="Filter HSN"></th>
      <th><input type="text" class="form-control filter-input" data-column="4" placeholder="Filter Batch"></th>
      <th><input type="date" class="form-control filter-input" data-column="5"></th>
      <th><input type="number" step="0.01" class="form-control filter-input" data-column="6" placeholder="Filter MRP"></th>
      <th><input type="number" step="0.01" class="form-control filter-input" data-column="7" placeholder="Filter Sale Rate"></th>
      <th><input type="number" step="0.01" class="form-control filter-input" data-column="8" placeholder="Filter Purchase Rate"></th>
      <th><input type="number" class="form-control filter-input" data-column="9" placeholder="Filter Qty"></th>
      <th><input type="number" step="0.01" class="form-control filter-input" data-column="10" placeholder="Filter GST%"></th>
      <th></th>
      <th></th>
      <th><button id="clear-filters" class="btn btn-sm btn-secondary" title="Clear Filters">Ã—</button></th>
    </tr>
  </thead>
  <tbody>
    {% for med in medicines %}
    <tr>
      <td>{{ med.id }}</td>
      <td>{{ med.name }}</td>
      <td>{{ med.packing or '' }}</td>
      <td>{{ med.hsn_code }}</td>
      <td>{{ med.batch_no }}</td>
      <td {% if med.near_expiry %}class="table-danger"{% endif %}>{{ med.expiry_date }}</td>
      <td>{{ "%.2f"|format(med.mrp or 0) }}</td>
      <td>{{ "%.2f"|format(med.sale_rate or 0) }}</td>
      <td>{{ "%.2f"|format(med.purchase_rate or 0) }}</td>
      <td {% if med.stock_qty < 0 %}class="table-danger"{% endif %}><b>{{ med.stock_qty }}</b></td>
      <td>{{ "%.2f"|format((med.sgst_percent or 0) + (med.cgst_percent or 0)) }}</td>
      <td>
        <form method="post" class="d-inline">
          <input type="hidden" name="startedit_id" value="{{ med.id }}">
          <button class="btn btn-sm btn-warning">Edit</button>
        </form>
      </td>
      <td>
        <form method="post" class="d-inline">
          <input type="hidden" name="view_sales_id" value="{{ med.id }}">
          <button class="btn btn-sm btn-info">Sales</button>
        </form>
      </td>
      <td>
        <form method="post" class="d-inline">
          <input type="hidden" name="view_purchases_id" value="{{ med.id }}">
          <button class="btn btn-sm btn-primary">Purchases</button>
        </form>
      </td>
      <td>
        <form method="post" class="d-inline" onsubmit="return confirm('Delete this medicine?');">
          <input type="hidden" name="delmedicine_id" value="{{ med.id }}">
          <button class="btn btn-sm btn-danger">Delete</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="14" class="text-muted">No medicines yet.</td></tr>
    {% endfor %}
  </tbody>
</table>

{% if show_sales and medicine_detail %}
<hr>
<h4>Sales History for {{ medicine_detail.name }} - Batch {{ medicine_detail.batch_no }}, Exp: {{ medicine_detail.expiry_date }}</h4>
<table class="table table-bordered table-striped text-center">
  <thead>
    <tr><th>Sale ID</th><th>Invoice</th><th>Date</th><th>Patient</th><th>Qty</th><th>Amount</th><th>View</th></tr>
  </thead>
  <tbody>
    {% for s in sales_history %}
    <tr>
      <td>{{ s.id }}</td>
      <td>{{ s.invoice_no }}</td>
      <td>{{ s.sale_datetime }}</td>
      <td>{{ s.patient_name or "" }}</td>
      <td>{{ s.quantity }}</td>
      <td>{{ s.amount }}</td>
      <td><a href="/bill/{{ s.id }}" class="btn btn-sm btn-primary">View</a></td>
    </tr>
    {% else %}
    <tr><td colspan="7" class="text-muted">No sales for this medicine entry.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

{% if show_purchases and medicine_detail %}
<hr>
<h4>Purchase History for {{ medicine_detail.name }} - Batch {{ medicine_detail.batch_no }}, Exp: {{ medicine_detail.expiry_date }}</h4>
<table class="table table-bordered table-striped text-center">
  <thead>
    <tr><th>Invoice</th><th>Date</th><th>Distributor</th><th>Qty</th><th>Amount</th></tr>
  </thead>
  <tbody>
    {% for p in purchases_history %}
    <tr>
      <td>{{ p.invoice_no }}</td>
      <td>{{ p.purchase_date }}</td>
      <td>{{ p.distributor_name or "" }}</td>
      <td>{{ p.quantity }}</td>
      <td>{{ p.amount }}</td>
    </tr>
    {% else %}
    <tr><td colspan="5" class="text-muted">No purchases for this medicine entry.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<button id="clear-filters" class="btn btn-secondary mt-3">Clear Filters</button>

<script>
function validateForm() {
    let name = document.querySelector('[name="name"]').value.trim();
    if (!name) {
        alert("Warning: Medicine name is required.");
        return false;
    }
    return true;
}

// Use shared filter utility
;(function(){
  function run() { if (window.ui && window.ui.applyFilters) window.ui.applyFilters('medicines-table', 'clear-filters'); }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run); else run();
})();
</script>

{% endblock %}
