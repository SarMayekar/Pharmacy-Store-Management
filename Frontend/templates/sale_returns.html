{% extends "base.html" %}
{% block content %}
<h2>Sales Returns</h2>

<form method="post" class="mb-4">
  <input type="hidden" name="rowcount" value="{{ sales_rowcount }}">
  {% if edit_sale_return_id %}
  <input type="hidden" name="edit_sale_return_id" value="{{ edit_sale_return_id }}">
  {% endif %}

  <label class="form-label mt-2">Return Invoice No.</label>
  <input type="text" name="invoice_no" class="form-control mb-2" value="{{ sales_return_invoice_no or '' }}" readonly>

  <label class="form-label">Date</label>
  <input type="date" name="return_date" class="form-control mb-2" value="{{ sales_return_date or '' }}" required>

  <label class="form-label mt-2">Patient Name</label>
  <input type="text" name="patient_name" list="patient_list" placeholder="Start typing or add new..." required
         class="form-control mb-2" value="{{ patient_name or '' }}">
  <datalist id="patient_list">
    {% for patient in patients %}
    <option value="{{ patient.name }}">
    {% endfor %}
  </datalist>

  <!-- Patient Contact Number -->
  <label class="form-label">Patient Contact Number</label>
  <input type="text" name="patient_contact" id="patient_contact" placeholder="Optional" class="form-control mb-3" value="{{ patient_contact or '' }}">

  <hr>
  <h4>Returned Items</h4>
  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead>
        <tr>
          <th>Action</th>
          <th>Product</th>
          <th>Packing</th>
          <th>Batch</th>
          <th>Expiry</th>
          <th>HSN</th>
          <th>MRP</th>
          <th>Qty</th>
          <th>Rate</th>
          <th>Discount %</th>
          <th>GST %</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody>
      {% for i in range(sales_rowcount) %}
        <tr>
          <td>
            <button type="submit" name="delrow" value="{{ i }}" class="btn btn-sm btn-danger" title="Delete row">×</button>
          </td>
          <td>
            <input type="text" name="items-{{ i }}-product" id="items-{{ i }}-product" list="medicine_list" placeholder="Type/select medicine" class="form-control"
                   value="{{ (sales_items[i] and sales_items[i]['product']) or (items[i] and items[i]['product']) or '' }}">
          </td>
          <td>
            <input type="text" name="items-{{ i }}-packing" id="items-{{ i }}-packing" class="form-control" placeholder="Packing"
                   value="{{ sales_return_items[i]['packing'] if sales_return_items|length > i else '' }}">
          </td>
          <td>
            <input type="text" name="items-{{ i }}-batch_no" id="items-{{ i }}-batch_no" class="form-control" placeholder="Batch"
                   value="{{ (sales_items[i] and sales_items[i]['batch_no']) or (items[i] and items[i]['batch_no']) or '' }}">
          </td>
          <td>
            <input type="date" name="items-{{ i }}-expiry_date" id="items-{{ i }}-expiry_date" class="form-control"
                   value="{{ (sales_items[i] and sales_items[i]['expiry_date']) or (items[i] and items[i]['expiry_date']) or '' }}">
          </td>
          <td>
            <input type="text" name="items-{{ i }}-hsn_code" id="items-{{ i }}-hsn_code" class="form-control" placeholder="HSN"
                   value="{{ (sales_items[i] and sales_items[i]['hsn_code']) or (items[i] and items[i]['hsn_code']) or '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-mrp" id="items-{{ i }}-mrp" class="form-control" placeholder="MRP"
                   value="{{ (sales_items[i] and sales_items[i]['mrp']) or (items[i] and items[i]['mrp']) or '' }}">
          </td>
          <td>
            <input type="number" step="1" min="0" name="items-{{ i }}-quantity" class="form-control" placeholder="Qty"
                   value="{{ (sales_items[i] and sales_items[i]['quantity']) or (items[i] and items[i]['quantity']) or '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-rate" class="form-control" placeholder="Rate"
                   value="{{ (sales_items[i] and sales_items[i]['rate']) or (items[i] and items[i]['rate']) or '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" max="100" name="items-{{ i }}-discount_percent" class="form-control" placeholder="Discount%"
                   value="{{ (items[i] and items[i]['discount_percent']) or '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" max="100" name="items-{{ i }}-gst_percent" id="items-{{ i }}-gst_percent" class="form-control" placeholder="GST%"
                   value="{{ ((items[i].sgst_percent|default(0)|float) + (items[i].cgst_percent|default(0)|float)) if items and items[i] else '' }}">
          </td>
          <input type="hidden" name="items-{{ i }}-sgst_percent" id="items-{{ i }}-sgst_percent" value="{{ items[i]['sgst_percent'] if items|length > i else '' }}">
          <input type="hidden" name="items-{{ i }}-cgst_percent" id="items-{{ i }}-cgst_percent" value="{{ items[i]['cgst_percent'] if items|length > i else '' }}">
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-amount" class="form-control" placeholder="Amount"
                   value="{{ (sales_items[i] and sales_items[i]['amount']) or (items[i] and items[i]['amount']) or '' }}">
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  <button type="submit" name="addrow" value="1" class="btn btn-secondary mb-3">Add Row</button>

  <div class="row mb-3">
    <div class="col-md-6 text-end">
      <label class="form-label"><b>MRP Total</b></label>
      <input type="number" step="0.01" min="0" name="grand_total_mrp" class="form-control d-inline-block" style="width:200px"
             value="{{ sales_grand_total_mrp if sales_grand_total_mrp else '' }}">
    </div>
    <div class="col-md-6 text-end">
      <label class="form-label"><b>Grand Total</b></label>
      <input type="number" step="0.01" min="0" name="grand_total_actual" class="form-control d-inline-block" style="width:200px"
             value="{{ sales_grand_total_actual if sales_grand_total_actual else '' }}">
    </div>
  </div>  <script>
  function validateForm() {
    const patient = document.querySelector('[name="patient_name"]').value.trim();
    const returnDate = document.querySelector('[name="return_date"]').value.trim();
    if (!patient) { alert('Patient Name is required'); return false; }
    if (!returnDate) { alert('Return date is required'); return false; }
    const rowcount = parseInt(document.querySelector('[name="rowcount"]').value || '0');
    let hasOneItem = false;
    for (let i=0;i<rowcount;i++) if (document.querySelector(`[name="items-${i}-product"]`).value.trim()) { hasOneItem = true; break; }
    if (!hasOneItem) { alert('At least one returned item is required'); return false; }
    return true;
  }
  </script>
  <button type="submit" name="savesalesreturn" value="1" class="btn btn-primary mb-3" onclick="return validateForm()">Save Sales Return</button>
</form>

<datalist id="medicine_list">
  {% for med in medicines %}
  <option value="{{ med.name }}" label="{{ med.name }} ({{ med.batch_no }}, {{ med.expiry_date }})">
  {% endfor %}
</datalist>

<!-- Sales Returns History Table -->
<h4>Sales Returns History</h4>
<table class="table table-bordered table-striped text-center" id="sales-returns-history-table">
  <thead>
    <tr>
      <th>Invoice ID</th>
      <th>Patient Name</th>
      <th>Date</th>
      <th>No. of Items</th>
      <th>Amount Total</th>
      <th>Edit</th>
      <th>Print/View</th>
      <th>Delete</th>
    </tr>
    <tr class="filter-row">
      <th><input type="text" class="form-control filter-input" data-column="0" placeholder="Filter Invoice ID"></th>
      <th><input type="text" class="form-control filter-input" data-column="1" placeholder="Filter Patient Name"></th>
      <th><input type="date" class="form-control filter-input" data-column="2"></th>
      <th><input type="number" class="form-control filter-input" data-column="3" placeholder="Filter No. of Items"></th>
      <th><input type="number" step="0.01" class="form-control filter-input" data-column="4" placeholder="Filter Amount Total"></th>
      <th></th>
      <th></th>
      <th><button id="clear-filters" class="btn btn-sm btn-secondary" title="Clear Filters">×</button></th>
    </tr>
  </thead>
  <tbody>
    {% for ret in sales_returns_history %}
    <tr>
      <td>{{ ret.invoice_no }}</td>
      <td>{{ ret.patient_name or '' }}</td>
      <td>{{ ret.return_datetime }}</td>
      <td>{{ ret.item_count }}</td>
      <td>{{ "%.2f"|format(ret.total_amount) }}</td>
      <td>
        <form method="post" class="d-inline">
          <input type="hidden" name="startedit_salesreturn_id" value="{{ ret.id }}">
          <button type="submit" class="btn btn-sm btn-warning">Edit</button>
        </form>
      </td>
      <td>
        <a href="/sales-return/{{ ret.id }}" class="btn btn-sm btn-primary">Print/View</a>
      </td>
      <td>
        <form method="post" class="d-inline" onsubmit="return confirm('Delete this sales return?');">
          <input type="hidden" name="delsalesreturn_id" value="{{ ret.id }}">
          <button type="submit" class="btn btn-sm btn-danger">Delete</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="8" class="text-muted">No sales returns yet.</td></tr>
    {% endfor %}
  </tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Initialize filters for the history table
    if (window.ui && window.ui.applyFilters) {
        window.ui.applyFilters('sales-returns-history-table', 'clear-filters');
    } else if (window.applyFilters) { // Fallback for older structure
        window.applyFilters('sales-returns-history-table', 'clear-filters');
    }
    // Initialize autofill and calculations for the form
    if (window.ui && window.ui.initializePage) {
        window.ui.initializePage(document.querySelector('form'));
    }

    // Attach listeners and run initial calculation
    const rows = document.querySelectorAll('[name^="items-"][name$="-quantity"]');
    if (window.calc && window.calc.attachRowListeners) {
        for (let i = 0; i < rows.length; i++) {
            window.calc.attachRowListeners(i, document);
        }
        window.calc.attachTotalListeners(document);
        window.calc.recalcAll(document);
    }

    // When a per-row combined GST% is changed, split into SGST/CGST halves
    function bindRowGstSplit() {
      const rowcount = parseInt(document.querySelector('[name="rowcount"]').value || '0');
      for (let i=0;i<rowcount;i++) {
        const gstEl = document.querySelector(`[name="items-${i}-gst_percent"]`);
        if (!gstEl) continue;
        gstEl.addEventListener('input', function(){
          if (window.calc && window.calc.splitGst) {
            window.calc.splitGst(i, document);
            window.calc.calcRow(i, document);
            window.calc.recalcAll(document);
          }
        });
      }
    }
    bindRowGstSplit();
});
</script>

{% endblock %}