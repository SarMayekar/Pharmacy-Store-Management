{% extends "base.html" %}
{% block content %}
<style>
.expiry-near {
    background-color: #f8d7da !important; /* Light red background */
}
</style>
<h2>Purchases</h2>
<form method="post" class="mb-4">
  <input type="hidden" name="rowcount" value="{{ rowcount }}">
  <input type="hidden" name="edit_purchase_id" value="{{ edit_purchase_id or '' }}">

  <label class="form-label">Invoice No.</label>
  <input type="text" name="invoice_no" placeholder="Invoice No" required class="form-control mb-2" value="{{ editing_purchase['invoice_no'] if editing_purchase else invoice_no or '' }}">

  <label class="form-label">Distributor</label>
  <input type="text" name="distributor_name" list="distributor_list" placeholder="Distributor" required class="form-control mb-2" value="{{ editing_purchase['distributor_name'] if editing_purchase else distributor_name or '' }}" id="distributor_name">
  <datalist id="distributor_list">
    {% for dist in distributors %}
      <option value="{{ dist.name }}">
    {% endfor %}
  </datalist>
  <datalist id="medicine_list">
    {% for med in medicines %}
      <option value="{{ med.name }}">
    {% endfor %}
  </datalist>

  <!-- Distributor Contact Number -->
  <label class="form-label">Distributor Contact Number</label>
  <input type="text" name="distributor_contact" placeholder="Optional" class="form-control mb-2" value="{{ editing_purchase['distributor_contact'] if editing_purchase else distributor_contact or '' }}" id="distributor_contact">

  <label class="form-label">Trade Type</label>
  <select name="trade_type" class="form-select mb-2" id="trade_type">
    <option value="">--</option>
    <option value="Retail" {% if editing_purchase and editing_purchase['trade_type'] == 'Retail' %}selected{% endif %}>Retail</option>
    <option value="Wholesale" {% if editing_purchase and editing_purchase['trade_type'] == 'Wholesale' %}selected{% endif %}>Wholesale</option>
  </select>

  <label class="form-label">Date</label>
  <input type="date" name="purchase_date" class="form-control mb-3" value="{{ editing_purchase['purchase_date'] if editing_purchase else purchase_date or '' }}">

  <hr>
  <h4>Items</h4>
  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead>
        <tr>
          <th>Action</th>
          <th>Product</th>
          <th>Batch</th>
          <th>Expiry</th>
          <th>HSN</th>
          <th>MRP</th>
          <th>Qty</th>
          <th>Purchase Rate</th>
          <th>Sale Discount %</th>
          <th>Sale Rate</th>
          <th>SGST %</th>
          <th>CGST %</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody>
      {% for i in range(rowcount) %}
        <tr>
          <td>
            <button type="submit" name="delrow" value="{{ i }}" class="btn btn-sm btn-danger" title="Delete row">×</button>
          </td>
          <td>
            <input type="text" name="items-{{ i }}-product" id="items-{{ i }}-product" list="medicine_list" class="form-control" placeholder="Product"
                   value="{{ items[i]['product'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="text" name="items-{{ i }}-batch_no" id="items-{{ i }}-batch_no" class="form-control" placeholder="Batch"
                   value="{{ items[i]['batch_no'] if items|length > i else '' }}">
          </td>
<td>
  <input type="date" name="items-{{ i }}-expiry_date" id="items-{{ i }}-expiry_date" class="form-control expiry-date-input"
         value="{{ items[i]['expiry_date'] if items|length > i else '' }}">
</td>
          <td>
            <input type="text" name="items-{{ i }}-hsn_code" id="items-{{ i }}-hsn_code" class="form-control" placeholder="HSN"
                   value="{{ items[i]['hsn_code'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-mrp" id="items-{{ i }}-mrp" class="form-control" placeholder="MRP"
                   value="{{ items[i]['mrp'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="1" min="0" name="items-{{ i }}-quantity" class="form-control" placeholder="Qty"
                   value="{{ items[i]['quantity'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-rate" class="form-control" placeholder="Pur. Rate"
                   value="{{ items[i]['rate'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" max="100" name="items-{{ i }}-sale_discount_percent" class="form-control" placeholder="Sale Disc%"
                   value="{{ items[i]['sale_discount_percent'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-sale_rate" class="form-control" placeholder="Sale Rate"
                   value="{{ items[i]['sale_rate'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" max="100" name="items-{{ i }}-sgst_percent" id="items-{{ i }}-sgst_percent" class="form-control" placeholder="SGST%"
                   value="{{ items[i]['sgst_percent'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" max="100" name="items-{{ i }}-cgst_percent" id="items-{{ i }}-cgst_percent" class="form-control" placeholder="CGST%"
                   value="{{ items[i]['cgst_percent'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-amount" class="form-control" placeholder="Amount"
                   value="{{ items[i]['amount'] if items|length > i else '' }}">
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="row mb-3">
    <div class="col text-end">
      <label for="grand_total" class="form-label"><b>Grand Total (Rs):</b></label>
      <input type="number" step="0.01" name="grand_total" id="grand_total" class="form-control d-inline-block" style="width:200px"
      value="{{ grand_total if grand_total else '' }}">
    </div>
  </div>
  <button type="submit" name="addrow" value="1" class="btn btn-secondary mb-2">Add Row</button>
  <button type="submit" name="savepurchase" value="1" class="btn btn-primary mb-2" onclick="return validateForm()">Save Purchase</button>
</form>
<hr>
<h4>Purchase Records</h4>
<table class="table table-bordered table-striped text-center" id="purchases-history-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Invoice</th>
      <th>Distributor</th>
      <th>Trade</th>
      <th>Date</th>
      <th>Total Amount</th>
      <th>Edit</th>
      <th>View</th>
      <th>Delete</th>
    </tr>
    <tr class="filter-row">
      <th><input type="number" class="form-control filter-input" data-column="0" placeholder="Filter ID"></th>
      <th><input type="text" class="form-control filter-input" data-column="1" placeholder="Filter Invoice"></th>
      <th><input type="text" class="form-control filter-input" data-column="2" placeholder="Filter Distributor"></th>
      <th>
        <select class="form-control filter-input" data-column="3">
          <option value="">All</option>
          <option value="Retail">Retail</option>
          <option value="Wholesale">Wholesale</option>
        </select>
      </th>
      <th><input type="date" class="form-control filter-input" data-column="4"></th>
      <th><input type="number" step="0.01" class="form-control filter-input" data-column="5" placeholder="Filter Total Amount"></th>
      <th></th>
      <th></th>
      <th><button id="clear-filters" class="btn btn-sm btn-secondary" title="Clear Filters">×</button></th>
    </tr>
  </thead>
  <tbody>
    {% for purchase in purchases_history %}
    <tr>
      <td>{{purchase.id}}</td>
      <td>{{purchase.invoice_no}}</td>
      <td>{{purchase.distributor_name}}</td>
      <td>{{purchase.trade_type}}</td>
      <td>{{purchase.purchase_date}}</td>
      <td>{{"%.2f"|format(purchase.total_amount)}}</td>
      <td>
        <form method="post" class="d-inline">
          <input type="hidden" name="startedit_id" value="{{purchase.id}}">
          <button class="btn btn-sm btn-warning">Edit</button>
        </form>
      </td>
      <td>
        <a href="{{ url_for('purchase_detail_view', purchase_id=purchase.id) }}" class="btn btn-sm btn-primary">View</a>
      </td>
      <td>
        <form method="post" class="d-inline" onsubmit="return confirm('Delete this purchase?');">
          <input type="hidden" name="delpurchase_id" value="{{purchase.id}}">
          <button class="btn btn-sm btn-danger">Delete</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="9" class="text-muted">No purchases yet.</td></tr>
    {% endfor %}
  </tbody>
</table>

{% if show_detail and purchase_detail %}
<hr>
<div id="purchase-detail-section">
  <h3>Purchase #{{ purchase_detail.purchase.invoice_no }} | {{ purchase_detail.purchase.distributor_name }}</h3>
  <p><b>Date:</b> {{ purchase_detail.purchase.purchase_date }} | <b>Trade Type:</b> {{ purchase_detail.purchase.trade_type }}</p>
  <table class="table table-bordered mt-3">
    <thead>
      <tr>
        <th>Sr No</th>
        <th>Medicine</th>
        <th>Batch</th>
        <th>Expiry</th>
        <th>Qty</th>
        <th>Rate</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
      {% for idx, item in enumerate(purchase_detail['items'], 1) %}
      <tr>
        <td>{{ idx }}</td>
        <td>{{ item.name }}</td>
        <td>{{ item.batch_no }}</td>
        <td>{{ item.expiry_date }}</td>
        <td>{{ item.quantity }}</td>
        <td>{{ item.rate }}</td>
        <td>{{ item.amount }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <p><strong>Total Amount: Rs {{ purchase_detail.purchase.total_amount }}</strong></p>
</div>
{% endif %}

<button id="clear-filters" class="btn btn-secondary mt-3">Clear Filters</button>

<script>
window.addEventListener("load", function () {
    function toFloat(val) {
        var num = parseFloat(val); return isNaN(num) ? 0 : num;
    }
    function rowCount() {
        return document.querySelectorAll(`input[name^="items-"][name$="-quantity"]`).length;
    }
    // Use shared calculation utilities
    let rows = rowCount();
    for (let i = 0; i < rows; i++) window.calc.attachRowListeners(i, document);
    window.calc.attachTotalListeners(document);
    window.calc.recalcAll(document);

    // Recalculate when autofill updates fields
    document.addEventListener('autofill:medicine', function(e) {
      try { window.calc.calcRow(e.detail.rowIndex, document); window.calc.recalcAll(document); } catch (err) {}
    });

    function validateForm() {
        let invoiceNo = document.querySelector('[name="invoice_no"]').value.trim();
        if (!invoiceNo) {
            alert("Warning: Invoice number is required.");
            return false;
        }

        let distributorName = document.querySelector('[name="distributor_name"]').value.trim();
        if (!distributorName) {
            alert("Warning: Distributor name is required.");
            return false;
        }

        let rows = document.querySelectorAll(`input[name^="items-"][name$="-quantity"]`);
        if (rows.length === 0) {
            alert("Warning: At least one item is required.");
            return false;
        }

        let validItems = 0;
        for (let i = 0; i < rows.length; i++) {
            let product = document.querySelector(`[name="items-${i}-product"]`).value.trim();
            let qty = document.querySelector(`[name="items-${i}-quantity"]`).value.trim();
            let rate = document.querySelector(`[name="items-${i}-rate"]`).value.trim();

            if (product && qty && rate) {
                let qtyVal = toFloat(qty);
                let rateVal = toFloat(rate);
                if (qtyVal <= 0 || rateVal <= 0) {
                    alert(`Warning: Item ${i+1}: Quantity and rate must be positive.`);
                    return false;
                }
                validItems++;
            } else if (product || qty || rate) {
                alert(`Warning: Item ${i+1}: Incomplete item data.`);
                return false;
            }
        }

        if (validItems === 0) {
            alert("Warning: At least one complete item is required.");
            return false;
        }

        let grandTotal = document.querySelector('[name="grand_total"]').value.trim();
        if (!grandTotal) {
            alert("Warning: Grand total is required.");
            return false;
        }

        return true;
    }

    // Autofill distributor details
    document.getElementById('distributor_name').addEventListener('input', function() {
        let name = this.value.trim();
        if (name) {
          window.autofill.fetchDistributor(name)
            .then(data => {
              window.autofill.fillContact('distributor_contact', data);
              if (data.trade_type) {
                document.getElementById('trade_type').value = data.trade_type;
              }
            })
            .catch(error => console.error('Error fetching distributor details:', error));
        }
    });

    // Autofill for medicine details
    document.addEventListener('input', function(event) {
        if (event.target.matches('[id^="items-"][id$="-product"]')) {
            const productInput = event.target;
            const rowIndex = productInput.id.match(/items-(\d+)-product/)[1];
            const medicineName = productInput.value.trim();
            if (medicineName) {
                window.autofill.fetchMedicine(medicineName)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            if (data.length === 1) {
                                const med = data[0];
                    window.fillMedicineFields(rowIndex, med);
                            } else {
                                const batchInput = document.getElementById(`items-${rowIndex}-batch_no`);
                                const select = document.createElement('select');
                                select.id = batchInput.id;
                                select.name = batchInput.name;
                                select.className = batchInput.className;
                                select.innerHTML = '<option value="">Select Batch</option>' +
                                    data.map(med => `<option value="${med.batch_no}" data-med='${JSON.stringify(med)}'>${med.batch_no} (Expiry: ${med.expiry_date})</option>`).join('');
                                batchInput.parentNode.replaceChild(select, batchInput);
                                const firstMed = data[0];
                                select.value = firstMed.batch_no;
                    window.fillMedicineFields(rowIndex, firstMed);
                                select.addEventListener('change', function() {
                                    const selectedOption = this.options[this.selectedIndex];
                                    if (selectedOption.value) {
                                        const med = JSON.parse(selectedOption.getAttribute('data-med'));
                        window.fillMedicineFields(rowIndex, med);
                                    }
                                });
                            }
                        }
                    })
                    .catch(error => console.error('Error fetching medicine data:', error));
            }
        }
    });

    // fillMedicineFields is provided by the shared autofill.js (window.fillMedicineFields)
    
    // Expiry date highlighting logic
    function highlightExpiryRows() {
        const expiryInputs = document.querySelectorAll('.expiry-date-input');
        const now = new Date();
        const nearExpiryThreshold = 30; // days

        expiryInputs.forEach(input => {
            const tr = input.closest('tr');
            if (!input.value) {
                tr.classList.remove('expiry-near');
                return;
            }
            const expiryDate = new Date(input.value);
            const diffTime = expiryDate - now;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);

            if (diffDays >= 0 && diffDays <= nearExpiryThreshold) {
                tr.classList.add('expiry-near');
            } else {
                tr.classList.remove('expiry-near');
            }
        });
    }

    // Initial highlight on page load with delay
    setTimeout(highlightExpiryRows, 100);

    // Update highlight on expiry date input change
    document.querySelectorAll('.expiry-date-input').forEach(input => {
        input.addEventListener('input', highlightExpiryRows);
    });

    // Update highlight after adding a row
    const addRowBtn = document.querySelector('button[name="addrow"]');
    if (addRowBtn) {
        addRowBtn.addEventListener('click', function () {
            setTimeout(highlightExpiryRows, 100);
        });
    }
});

// Use shared filter utility
;(function(){
  function run() { if (window.ui && window.ui.applyFilters) window.ui.applyFilters('purchases-history-table', 'clear-filters'); }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run); else run();
})();
    // Expiry date highlighting logic
    function highlightExpiryRows() {
        const expiryInputs = document.querySelectorAll('.expiry-date-input');
        const now = new Date();
        const nearExpiryThreshold = 30; // days

        expiryInputs.forEach(input => {
            const tr = input.closest('tr');
            if (!input.value) {
                tr.classList.remove('expiry-near');
                return;
            }
            const expiryDate = new Date(input.value);
            const diffTime = expiryDate - now;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);

            if (diffDays >= 0 && diffDays <= nearExpiryThreshold) {
                tr.classList.add('expiry-near');
            } else {
                tr.classList.remove('expiry-near');
            }
        });
    }

    // Initial highlight on page load
    highlightExpiryRows();

    // Update highlight on expiry date input change
    document.querySelectorAll('.expiry-date-input').forEach(input => {
        input.addEventListener('input', highlightExpiryRows);
    });
</script>

{% endblock %}
