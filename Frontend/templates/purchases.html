{% extends "base.html" %}
{% block content %}
<style>
.expiry-near {
    background-color: #f8d7da !important; /* Light red background */
}
</style>
<h2>Purchases</h2>
<form method="post" class="mb-4">
  <input type="hidden" name="rowcount" value="{{ rowcount }}">
  <input type="hidden" name="edit_purchase_id" value="{{ edit_purchase_id or '' }}">

  <label class="form-label">Invoice No.</label>
  <input type="text" name="invoice_no" placeholder="Invoice No" required class="form-control mb-2" value="{{ editing_purchase['invoice_no'] if editing_purchase else invoice_no or '' }}">

  <label class="form-label">Distributor</label>
  <input type="text" name="distributor_name" list="distributor_list" placeholder="Distributor" required class="form-control mb-2" value="{{ editing_purchase['distributor_name'] if editing_purchase else distributor_name or '' }}" id="distributor_name">
  <datalist id="distributor_list">
    {% for dist in distributors %}
      <option value="{{ dist.name }}">
    {% endfor %}
  </datalist>
<datalist id="medicine_list">
  {% for med in medicines %}
  <option value="{{ med.name }}" label="{{ med.name }} ({{ med.batch_no }}, {{ med.expiry_date }})">
  {% endfor %}
</datalist>

  <!-- Distributor Contact Number -->
  <label class="form-label">Distributor Contact Number</label>
  <input type="text" name="distributor_contact" placeholder="Optional" class="form-control mb-2" value="{{ editing_purchase['distributor_contact'] if editing_purchase else distributor_contact or '' }}" id="distributor_contact">

  <label class="form-label">Trade Type</label>
  <select name="trade_type" class="form-select mb-2" id="trade_type">
    <option value="">--</option>
    <option value="Retail" {% if editing_purchase and editing_purchase['trade_type'] == 'Retail' %}selected{% endif %}>Retail</option>
    <option value="Wholesale" {% if editing_purchase and editing_purchase['trade_type'] == 'Wholesale' %}selected{% endif %}>Wholesale</option>
  </select>

  <label class="form-label">Date</label>
  <input type="date" name="purchase_date" class="form-control mb-3" value="{{ editing_purchase['purchase_date'] if editing_purchase else purchase_date or '' }}">

  <hr>
  <h4>Items</h4>
  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead>
        <tr>
          <th>Action</th>
          <th>Product</th>
          <th>Packing</th>
          <th>Batch</th>
          <th>Expiry</th>
          <th>HSN</th>
          <th>MRP</th>
          <th>Qty</th>
          <th>Free</th>
          <th>Purchase Rate</th>
          <th>Sale Discount %</th>
          <th>Sale Rate</th>
          <th>GST %</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody>
      {% for i in range(rowcount) %}
        <tr>
          <td>
            <button type="submit" name="delrow" value="{{ i }}" class="btn btn-sm btn-danger" title="Delete row">×</button>
          </td>
          <td>
            <input type="text" name="items-{{ i }}-product" id="items-{{ i }}-product" list="medicine_list" class="form-control" placeholder="Product"
                   value="{{ items[i]['product'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="text" name="items-{{ i }}-packing" id="items-{{ i }}-packing" class="form-control" placeholder="Packing"
                   value="{{ items[i]['packing'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="text" name="items-{{ i }}-batch_no" id="items-{{ i }}-batch_no" class="form-control" placeholder="Batch"
                   value="{{ items[i]['batch_no'] if items|length > i else '' }}">
          </td>
<td>
  <input type="date" name="items-{{ i }}-expiry_date" id="items-{{ i }}-expiry_date" class="form-control expiry-date-input"
         value="{{ items[i]['expiry_date'] if items|length > i else '' }}">
</td>
          <td>
            <input type="text" name="items-{{ i }}-hsn_code" id="items-{{ i }}-hsn_code" class="form-control" placeholder="HSN"
                   value="{{ items[i]['hsn_code'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-mrp" id="items-{{ i }}-mrp" class="form-control" placeholder="MRP"
                   value="{{ items[i]['mrp'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="1" min="0" name="items-{{ i }}-quantity" class="form-control" placeholder="Qty"
                   value="{{ items[i]['quantity'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="1" min="0" name="items-{{ i }}-free" class="form-control" placeholder="Free"
                   value="{{ items[i]['free'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-rate" class="form-control" placeholder="Pur. Rate"
                   value="{{ items[i]['rate'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" max="100" name="items-{{ i }}-sale_discount_percent" class="form-control" placeholder="Sale Disc%"
                   value="{{ items[i]['sale_discount_percent'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-sale_rate" class="form-control" placeholder="Sale Rate"
                   value="{{ items[i]['sale_rate'] if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" max="100" name="items-{{ i }}-gst_percent" id="items-{{ i }}-gst_percent" class="form-control" placeholder="GST%"
                   value="{{ (items[i]['sgst_percent']|default(0)|float + items[i]['cgst_percent']|default(0)|float) if items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-amount" class="form-control" placeholder="Amount"
                   value="{{ items[i]['amount'] if items|length > i else '' }}">
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="row mb-3">
    <div class="col-md-3 text-end">
      <label class="form-label"><b>Discount%</b></label>
      <input type="number" step="0.01" min="0" max="100" name="discount_percent" id="discount_percent" class="form-control d-inline-block" style="width:140px"
             value="{{ discount_percent if discount_percent else '0' }}">
    </div>
    <div class="col text-end">
      <label for="grand_total" class="form-label"><b>Grand Total (Rs):</b></label>
      <input type="number" step="0.01" name="grand_total" id="grand_total" class="form-control d-inline-block" style="width:200px"
      value="{{ grand_total if grand_total else '' }}">
    </div>
  </div>
  <script>
  function validateForm() {
    // Required: Invoice No., Distributor Name, At least one product with expiry date, Invoice Date, Grand Total
    const invoice = document.querySelector('[name="invoice_no"]').value.trim();
    const distributor = document.querySelector('[name="distributor_name"]').value.trim();
    const purchaseDate = document.querySelector('[name="purchase_date"]').value.trim();
    const grandTotal = document.querySelector('[name="grand_total"]').value.trim();
    if (!invoice) { alert('Invoice No. is required'); return false; }
    if (!distributor) { alert('Distributor name is required'); return false; }
    if (!purchaseDate) { alert('Invoice/ Purchase date is required'); return false; }
    if (!grandTotal) { alert('Grand total is required'); return false; }
    // At least one product with expiry date
    const rowcount = parseInt(document.querySelector('[name="rowcount"]').value || '0');
    let valid = false;
    for (let i=0;i<rowcount;i++){
      const prod = document.querySelector(`[name="items-${i}-product"]`).value.trim();
      const qty = document.querySelector(`[name="items-${i}-quantity"]`).value.trim();
      const rate = document.querySelector(`[name="items-${i}-rate"]`).value.trim();
      const expiry = document.querySelector(`[name="items-${i}-expiry_date"]`).value.trim();
      if (prod && qty && rate) {
        if (!expiry) { alert(`Row ${i+1}: Expiry date is required for entered product`); return false; }
        valid = true; break;
      }
    }
    if (!valid) { alert('At least one complete product row (product, qty, rate) with expiry date is required'); return false; }
    return true;
  }
  </script>
  <button type="submit" name="addrow" value="1" class="btn btn-secondary mb-2">Add Row</button>
  <button type="submit" name="savepurchase" value="1" class="btn btn-primary mb-2" onclick="return validateForm()">Save Purchase</button>
</form>
<hr>
<h4>Purchase Records</h4>
<table class="table table-bordered table-striped text-center" id="purchases-history-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Invoice</th>
      <th>Distributor</th>
      <th>Trade</th>
      <th>Date</th>
      <th>Total Amount</th>
      <th>Edit</th>
      <th>View</th>
      <th>Delete</th>
    </tr>
    <tr class="filter-row">
      <th><input type="number" class="form-control filter-input" data-column="0" placeholder="Filter ID"></th>
      <th><input type="text" class="form-control filter-input" data-column="1" placeholder="Filter Invoice"></th>
      <th><input type="text" class="form-control filter-input" data-column="2" placeholder="Filter Distributor"></th>
      <th>
        <select class="form-control filter-input" data-column="3">
          <option value="">All</option>
          <option value="Retail">Retail</option>
          <option value="Wholesale">Wholesale</option>
        </select>
      </th>
      <th><input type="date" class="form-control filter-input" data-column="4"></th>
      <th><input type="number" step="0.01" class="form-control filter-input" data-column="5" placeholder="Filter Total Amount"></th>
      <th></th>
      <th></th>
      <th><button id="clear-filters" class="btn btn-sm btn-secondary" title="Clear Filters">×</button></th>
    </tr>
  </thead>
  <tbody>
    {% for purchase in purchases_history %}
    <tr>
      <td>{{purchase.id}}</td>
      <td>{{purchase.invoice_no}}</td>
      <td>{{purchase.distributor_name}}</td>
      <td>{{purchase.trade_type}}</td>
      <td>{{purchase.purchase_date}}</td>
      <td>{{"%.2f"|format(purchase.total_amount)}}</td>
      <td>
        <form method="post" class="d-inline">
          <input type="hidden" name="startedit_id" value="{{purchase.id}}">
          <button class="btn btn-sm btn-warning">Edit</button>
        </form>
      </td>
      <td>
        <a href="{{ url_for('purchase_detail_view', purchase_id=purchase.id) }}" class="btn btn-sm btn-primary">View</a>
      </td>
      <td>
        <form method="post" class="d-inline" onsubmit="return confirm('Delete this purchase?');">
          <input type="hidden" name="delpurchase_id" value="{{purchase.id}}">
          <button class="btn btn-sm btn-danger">Delete</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="9" class="text-muted">No purchases yet.</td></tr>
    {% endfor %}
  </tbody>
</table>

{% if show_detail and purchase_detail %}
<hr>
<div id="purchase-detail-section">
  <h3>Purchase #{{ purchase_detail.purchase.invoice_no }} | {{ purchase_detail.purchase.distributor_name }}</h3>
  <p><b>Date:</b> {{ purchase_detail.purchase.purchase_date }} | <b>Trade Type:</b> {{ purchase_detail.purchase.trade_type }}</p>
  <table class="table table-bordered mt-3">
    <thead>
      <tr>
        <th>Sr No</th>
        <th>Medicine</th>
        <th>Batch</th>
        <th>Expiry</th>
        <th>Qty</th>
        <th>Rate</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
      {% for idx, item in enumerate(purchase_detail['items'], 1) %}
      <tr>
        <td>{{ idx }}</td>
        <td>{{ item.name }}</td>
        <td>{{ item.batch_no }}</td>
        <td>{{ item.expiry_date }}</td>
        <td>{{ item.quantity }}</td>
        <td>{{ item.rate }}</td>
        <td>{{ item.amount }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <p><strong>Total Amount: Rs {{ purchase_detail.purchase.total_amount }}</strong></p>
</div>
{% endif %}

<button id="clear-filters" class="btn btn-secondary mt-3">Clear Filters</button>

<script>
// Use shared filter utility
;(function(){
  function run() { if (window.ui && window.ui.applyFilters) window.ui.applyFilters('purchases-history-table', 'clear-filters'); }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run); else run();
})();
    // Expiry date highlighting logic
    function highlightExpiryRows() {
        const expiryInputs = document.querySelectorAll('.expiry-date-input');
        const now = new Date();
        const nearExpiryThreshold = 30; // days

        expiryInputs.forEach(input => {
            const tr = input.closest('tr');
            if (!input.value) {
                tr.classList.remove('expiry-near');
                return;
            }
            const expiryDate = new Date(input.value);
            const diffTime = expiryDate - now;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);

            if (diffDays >= 0 && diffDays <= nearExpiryThreshold) {
                tr.classList.add('expiry-near');
            } else {
                tr.classList.remove('expiry-near');
            }
        });
    }

    // Initial highlight on page load
    highlightExpiryRows();

    // Update highlight on expiry date input change
    document.querySelectorAll('.expiry-date-input').forEach(input => {
        input.addEventListener('input', highlightExpiryRows);
    });
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Initialize filters, autofill, and calculations
    if (window.ui) {
        window.ui.applyFilters('purchases-history-table', 'clear-filters');
        window.ui.initializePage(document.querySelector('form'));
    }

    // Autofill for distributor name
    document.getElementById('distributor_name').addEventListener('input', function() {
        const distributorName = this.value.trim();
        if (distributorName) {
            window.autofill.fetchDistributor(distributorName)
              .then(data => window.autofill.fillContact('distributor_contact', data))
              .catch(error => console.error('Error fetching distributor data:', error));
        }
    });

    // Autofill for medicine rows
    function bindMedicineAutofill() {
        const rowcount = parseInt(document.querySelector('[name="rowcount"]').value || '0');
        for (let i = 0; i < rowcount; i++) {
            const productInput = document.getElementById(`items-${i}-product`);
            if (productInput) {
                productInput.addEventListener('input', function() {
                    const medName = this.value.trim();
                    if (medName) {
                        window.autofill.fetchMedicine(medName)
                            .then(med => window.autofill.fillMedicineFields(i, med))
                            .catch(err => console.error('Error fetching medicine:', err));
                    }
                });
            }
        }
    }
    bindMedicineAutofill();
});
</script>

{% endblock %}
