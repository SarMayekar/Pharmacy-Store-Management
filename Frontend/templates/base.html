<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Pharmacy Management{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .navbar { margin-bottom: 25px; }
        /* Autofill visual indicator when inputs are populated programmatically */
        .autofilled { background-color: #e9f7ef !important; border-left: 3px solid #34a853; }
    </style>
    {% block head_extra %}{% endblock %}
    <script>
// Unified autofill utilities for medicines, patients, doctors and distributors
// Provides a `fillMedicineFields(rowIndex, med)` function and helper fetchers
window.autofill = (function() {
  function getIdCandidates(rowIndex, field) {
    return [
      `items-${rowIndex}-${field}`,
      `items-${rowIndex}-${field}-sales`,
      `items-${rowIndex}-${field}-purchase`
    ];
  }

  function setFirstExisting(rowIndex, field, value) {
    if (value === undefined || value === null) return;
    const ids = getIdCandidates(rowIndex, field);
    for (const id of ids) {
      const el = document.getElementById(id) || document.querySelector(`[name="${id}"]`);
      if (el) { el.value = value; el.classList.add('autofilled'); return true; }
    }
    return false;
  }

  function setByName(rowIndex, field, value) {
    if (value === undefined || value === null) return;
    const name = `items-${rowIndex}-${field}`;
    const el = document.querySelector(`[name="${name}"]`);
    if (el) { el.value = value; el.classList.add('autofilled'); return true; }
    // fallback: try suffixes
    const el2 = document.querySelector(`[name="${name}-sales"]`) || document.querySelector(`[name="${name}-purchase"]`);
    if (el2) { el2.value = value; return true; }
    return false;
  }

  function fillMedicineFields(rowIndex, med) {
    // Fill generic fields (batch, expiry, hsn, mrp, packing, gst fields)
    setFirstExisting(rowIndex, 'packing', med.packing);
    setFirstExisting(rowIndex, 'batch_no', med.batch_no);
    setFirstExisting(rowIndex, 'expiry_date', med.expiry_date);
    setFirstExisting(rowIndex, 'hsn_code', med.hsn_code);
    setFirstExisting(rowIndex, 'mrp', med.mrp);
    setFirstExisting(rowIndex, 'sgst_percent', med.sgst_percent);
    setFirstExisting(rowIndex, 'cgst_percent', med.cgst_percent);

    // Also update the combined GST field if it exists
    const gstEl = document.getElementById(`items-${rowIndex}-gst_percent}`) || document.querySelector(`[name="items-${rowIndex}-gst_percent"]`);
    if (gstEl) {
        const totalGst = (parseFloat(med.sgst_percent) || 0) + (parseFloat(med.cgst_percent) || 0);
        if (!isNaN(totalGst)) gstEl.value = totalGst.toFixed(2);
    }

    // Fill sale_rate if a dedicated sale_rate field exists
    if (med.sale_rate !== undefined) {
      // Try exact name first
      setByName(rowIndex, 'sale_rate', med.sale_rate);
    }

    // For the main `rate` field (name="items-<i>-rate") we pick the best candidate:
    // - If the page has a separate sale_rate field (name exists), we assume `rate` is purchase rate (purchases)
    // - Otherwise, treat `rate` as the sale rate (sales pages / returns where relevant)
    const rateEl = document.querySelector(`[name="items-${rowIndex}-rate"]`);
    const saleRateEl = document.querySelector(`[name="items-${rowIndex}-sale_rate"]`);
    if (rateEl) {
      if (saleRateEl) {
        // This is likely a purchases page (has both fields). Use purchase_rate when available
        if (med.purchase_rate !== undefined && med.purchase_rate !== null) rateEl.value = med.purchase_rate;
        else if (med.sale_rate !== undefined && med.sale_rate !== null) rateEl.value = med.sale_rate;
      } else {
        // No dedicated sale_rate field â€” treat `rate` as the sale rate first
        if (med.sale_rate !== undefined && med.sale_rate !== null) rateEl.value = med.sale_rate;
        else if (med.purchase_rate !== undefined && med.purchase_rate !== null) rateEl.value = med.purchase_rate;
      }
    }

    // After autofill, trigger a custom event so page-specific code can react (recalc or similar)
    try {
      const evt = new CustomEvent('autofill:medicine', { detail: { rowIndex, med } });
      document.dispatchEvent(evt);
    } catch (e) {
      // ignore
    }
  }

// Remove autofill visual marker when user edits a field manually
document.addEventListener('input', function(e) {
  try {
    const el = e.target;
    if (!el) return;
    const name = el.name || el.id || '';
    if (/^items-/.test(name)) {
      el.classList.remove('autofilled');
    }
  } catch (err) {}
});

  // Fetch helpers
  function fetchMedicine(name) {
    return fetch(`/api/medicine/${encodeURIComponent(name)}`).then(r => r.json());
  }

  function fetchPatient(name) {
    return fetch(`/api/patient/${encodeURIComponent(name)}`).then(r => r.json());
  }

  function fetchDistributor(name) {
    return fetch(`/api/distributor/${encodeURIComponent(name)}`).then(r => r.json());
  }

  function fetchDoctor(name) {
    return fetch(`/api/doctor/${encodeURIComponent(name)}`).then(r => r.json());
  }

  // Helper to autofill contact number into a field (if present)
  function fillContact(targetId, data) {
    try {
      if (!data) return;
      const el = document.getElementById(targetId) || document.querySelector(`[name="${targetId}"]`);
      if (el && data.contact_number) el.value = data.contact_number;
    } catch (e) {}
  }

  return {
    fillMedicineFields,
    fetchMedicine,
    fetchPatient,
    fetchDistributor,
    fetchDoctor,
    fillContact
  };
})();

// When other page code may expect plain fillMedicineFields in global scope, expose directly
window.fillMedicineFields = window.autofill.fillMedicineFields;

// UI utilities shared across pages
window.ui = (function() {
  function applyFilters(tableId, clearBtnId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const filterInputs = table.querySelectorAll('.filter-input');
    const rows = table.querySelectorAll('tbody tr');

    function filterRows() {
      const filters = {};
      filterInputs.forEach(input => {
        const idx = input.dataset.column;
        const val = input.value.trim().toLowerCase();
        if (val) filters[idx] = val;
      });
      rows.forEach(row => {
        let show = true;
        Object.entries(filters).forEach(([colIdx, filterVal]) => {
          const cell = row.cells[colIdx];
          if (cell && !cell.textContent.toLowerCase().includes(filterVal)) {
            show = false;
          }
        });
        row.style.display = show ? '' : 'none';
      });
    }

    filterInputs.forEach(input => {
      const eventType = (input.type === 'date' || input.tagName.toLowerCase() === 'select') ? 'change' : 'input';
      input.addEventListener(eventType, filterRows);
    });

    const clearBtn = document.getElementById(clearBtnId);
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        filterInputs.forEach(input => (input.value = ''));
        filterRows();
      });
    }

    // initial pass
    filterRows();
  }

  return {
    applyFilters
  };
})();

// Shared calculations utilities for rows and totals
window.calc = (function() {
  function toFloat(val) { var num = parseFloat(val); return isNaN(num) ? 0 : num; }

  function calcRow(index, container = document) {
    const qtyEl = container.querySelector(`[name="items-${index}-quantity"]`);
    if (!qtyEl) return; // no row
    let qty = toFloat(qtyEl.value);
    let rate = toFloat(container.querySelector(`[name="items-${index}-rate"]`)?.value);
    let discount_percent = toFloat(container.querySelector(`[name="items-${index}-discount_percent"]`)?.value) || 0;
    let sgst_percent = toFloat(container.querySelector(`[name="items-${index}-sgst_percent"]`)?.value) || 0;
    let cgst_percent = toFloat(container.querySelector(`[name="items-${index}-cgst_percent"]`)?.value) || 0;
    let amountInput = container.querySelector(`[name="items-${index}-amount"]`);
    if (amountInput && (!amountInput.dataset.locked || amountInput.value.trim() === "")) {
      let base_total = qty * rate;
      let discount_amt = base_total * (discount_percent / 100);
      let discounted_total = base_total - discount_amt;
      let gst_amt = discounted_total * ((sgst_percent + cgst_percent) / 100);
      let row_final_amount = discounted_total + gst_amt;
      amountInput.value = row_final_amount > 0 ? row_final_amount.toFixed(2) : "";
    }

    // sale rate calculation if applicable
    let mrp = toFloat(container.querySelector(`[name="items-${index}-mrp"]`)?.value);
    let saleDiscountEl = container.querySelector(`[name="items-${index}-sale_discount_percent"]`) || container.querySelector(`[name="items-${index}-discount_percent"]`);
    let saleDiscount = toFloat(saleDiscountEl?.value);
    let saleRateInput = container.querySelector(`[name="items-${index}-sale_rate"]`);
    if (saleRateInput && saleDiscount > 0) {
      let sRate = mrp - (mrp * saleDiscount / 100);
      saleRateInput.value = sRate.toFixed(2);
    }
  }

  function recalcAll(container = document) {
    const form = container.closest('form');
    const isSales = form && form.action.includes('sales');
    const rows = container.querySelectorAll('[name^="items-"][name$="-quantity"]');
    let total_mrp = 0, total_actual = 0;
    rows.forEach((qtyInput, idx) => {
      calcRow(idx, container);
      let mrp = toFloat(container.querySelector(`[name="items-${idx}-mrp"]`)?.value);
      let qty = toFloat(qtyInput.value);
      let amount = toFloat(container.querySelector(`[name="items-${idx}-amount"]`)?.value);
      let item_mrp_total = mrp * qty; // GST ignored in math engine
      total_mrp += item_mrp_total;
      total_actual += amount;
    });

    // try commonly named grand inputs
    const mrpInput = container.querySelector('[name="grand_total_mrp"]');
    const actualInput = container.querySelector('[name="grand_total_actual"]') || container.querySelector('[name="grand_total"]');
    const savingsInput = container.querySelector('[name="savings_total"]');
    if (mrpInput && (!mrpInput.dataset.locked || mrpInput.value.trim() === "")) mrpInput.value = total_mrp > 0 ? total_mrp.toFixed(2) : "";
    if (actualInput && (!actualInput.dataset.locked || actualInput.value.trim() === "")) actualInput.value = total_actual > 0 ? total_actual.toFixed(2) : "";
    if (savingsInput && (!savingsInput.dataset.locked || savingsInput.value.trim() === "")) savingsInput.value = (total_mrp - total_actual > 0) ? (total_mrp - total_actual).toFixed(2) : "";
  }

  function attachRowListeners(idx, container = document) {
    // support both discount field names used across templates
    ['quantity','rate','sgst_percent','cgst_percent','sale_discount_percent','discount_percent','mrp'].forEach(field => {
      const el = container.querySelector(`[name="items-${idx}-${field}"]`);
      if (el) el.addEventListener('input', function(){ calcRow(idx, container); recalcAll(container); });
    });
    const amount = container.querySelector(`[name="items-${idx}-amount"]`);
    if (amount) amount.addEventListener('input', function(){ amount.dataset.locked = (amount.value.trim() !== ''); recalcAll(container); });
  }

  function attachTotalListeners(container = document) {
    const mrpInput = container.querySelector('[name="grand_total_mrp"]');
    const actualInput = container.querySelector('[name="grand_total_actual"]') || container.querySelector('[name="grand_total"]');
    const savingsInput = container.querySelector('[name="savings_total"]');
    function handleMrp(){ if (!mrpInput) return; mrpInput.dataset.locked = (mrpInput.value.trim() !== ''); if (!savingsInput?.dataset.locked) { let v = toFloat(mrpInput.value) - toFloat(actualInput?.value); if (savingsInput) savingsInput.value = v>0? v.toFixed(2):''; } }
    function handleActual(){ if (!actualInput) return; actualInput.dataset.locked = (actualInput.value.trim() !== ''); if (!savingsInput?.dataset.locked) { let v = toFloat(mrpInput?.value) - toFloat(actualInput.value); if (savingsInput) savingsInput.value = v>0? v.toFixed(2):''; } }
    function handleSavings(){ if (!savingsInput) return; savingsInput.dataset.locked = (savingsInput.value.trim() !== ''); if (!actualInput?.dataset.locked) { let v = toFloat(mrpInput?.value) - toFloat(savingsInput.value); if (actualInput) actualInput.value = v>0? v.toFixed(2):''; } }
    if (mrpInput) mrpInput.addEventListener('input', handleMrp);
    if (actualInput) actualInput.addEventListener('input', handleActual);
    if (savingsInput) savingsInput.addEventListener('input', handleSavings);
  }

  return {
    toFloat, calcRow, recalcAll, attachRowListeners, attachTotalListeners
  };
})();
    </script>
    <script src="/static/js/calculations.js?v=2"></script>
    <script src="/static/js/ui-utils.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">Astitva Drug House</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link {% if request.path == '/' %}active{% endif %}" href="/">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path.startswith('/sales') %}active{% endif %}" href="/sales">Sales</a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path.startswith('/purchases') %}active{% endif %}" href="/purchases">Purchases</a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path.startswith('/medicines') %}active{% endif %}" href="/medicines">Medicines</a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path.startswith('/patients') %}active{% endif %}" href="/patients">Patients</a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path.startswith('/doctors') %}active{% endif %}" href="/doctors">Doctors</a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path.startswith('/distributors') %}active{% endif %}" href="/distributors">Distributors</a></li>
                    <li class="nav-item"><a class="nav-link {% if request.path.startswith('/returns') %}active{% endif %}" href="/returns">Returns</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{category}} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    {% block body_extra %}{% endblock %}
</body>
</html>