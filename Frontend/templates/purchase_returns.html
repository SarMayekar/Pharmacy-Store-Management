{% extends "base.html" %}
{% block content %}
<style>
.expiry-near { background-color: #f8d7da !important; }
</style>
<h2>Purchase Returns</h2>
<form method="post" class="mb-4">
  <input type="hidden" name="rowcount" value="{{ purchase_rowcount }}">
  <input type="hidden" name="edit_purchase_return_id" value="{{ edit_purchase_return_id or '' }}">

  <label class="form-label">Invoice No.</label>
  <input type="text" name="invoice_no" placeholder="Invoice No" required class="form-control mb-2" value="{{ purchase_return_invoice_no or '' }}">

  <label class="form-label">Distributor</label>
  <input type="text" name="distributor_name" list="distributor_list" placeholder="Distributor" required class="form-control mb-2" value="{{ distributor_name or '' }}" id="distributor_name">
  <datalist id="distributor_list">
    {% for dist in distributors %}
      <option value="{{ dist.name }}">
    {% endfor %}
  </datalist>

  <!-- Distributor Contact Number -->
  <label class="form-label">Distributor Contact Number</label>
  <input type="text" name="distributor_contact" placeholder="Optional" class="form-control mb-2" value="{{ distributor_contact or '' }}" id="distributor_contact">

  <label class="form-label">Date</label>
  <input type="date" name="return_date" class="form-control mb-3" value="{{ purchase_return_date or '' }}">

  <hr>
  <h4>Items</h4>
  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead>
        <tr>
          <th>Action</th>
          <th>Product</th>
          <th>Packing</th>
          <th>Batch</th>
          <th>Expiry</th>
          <th>HSN</th>
          <th>MRP</th>
          <th>Qty</th>
          <th>Free</th>
          <th>Purchase Rate</th>
          <th>GST %</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody>
      {% for i in range(purchase_rowcount) %}
        <tr>
          <td>
            <button type="submit" name="delrow" value="{{ i }}" class="btn btn-sm btn-danger" title="Delete row">Ã—</button>
          </td>
          <td>
            <input type="text" name="items-{{ i }}-product" id="items-{{ i }}-product" list="medicine_list" class="form-control" placeholder="Product"
                   value="{{ purchase_items[i]['product'] if purchase_items|length > i else '' }}">
          </td>
          <td>
            <input type="text" name="items-{{ i }}-packing" id="items-{{ i }}-packing" class="form-control" placeholder="Packing"
                   value="{{ purchase_items[i]['packing'] if purchase_items|length > i else '' }}">
          </td>
          <td>
            <input type="text" name="items-{{ i }}-batch_no" id="items-{{ i }}-batch_no" class="form-control" placeholder="Batch"
                   value="{{ purchase_items[i]['batch_no'] if purchase_items|length > i else '' }}">
          </td>
          <td>
            <input type="date" name="items-{{ i }}-expiry_date" id="items-{{ i }}-expiry_date" class="form-control expiry-date-input"
                   value="{{ purchase_items[i]['expiry_date'] if purchase_items|length > i else '' }}">
          </td>
          <td>
            <input type="text" name="items-{{ i }}-hsn_code" id="items-{{ i }}-hsn_code" class="form-control" placeholder="HSN"
                   value="{{ purchase_items[i]['hsn_code'] if purchase_items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-mrp" id="items-{{ i }}-mrp" class="form-control" placeholder="MRP"
                   value="{{ purchase_items[i]['mrp'] if purchase_items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="1" min="0" name="items-{{ i }}-quantity" class="form-control" placeholder="Qty"
                   value="{{ purchase_items[i]['quantity'] if purchase_items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="1" min="0" name="items-{{ i }}-free" class="form-control" placeholder="Free"
                   value="{{ purchase_items[i]['free'] if purchase_items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-rate" class="form-control" placeholder="Pur. Rate"
                   value="{{ purchase_items[i]['rate'] if purchase_items|length > i else '' }}">
          </td>
          <td>
            <input type="number" step="0.01" min="0" max="100" name="items-{{ i }}-gst_percent" id="items-{{ i }}-gst_percent" class="form-control" placeholder="GST%"
                   value="{{ (purchase_items[i]['sgst_percent']|default(0)|float + purchase_items[i]['cgst_percent']|default(0)|float) if purchase_items|length > i else '' }}">
          </td>
          <input type="hidden" name="items-{{ i }}-sgst_percent" id="items-{{ i }}-sgst_percent" value="{{ purchase_items[i]['sgst_percent'] if purchase_items|length > i else '' }}">
          <input type="hidden" name="items-{{ i }}-cgst_percent" id="items-{{ i }}-cgst_percent" value="{{ purchase_items[i]['cgst_percent'] if purchase_items|length > i else '' }}">
          <td>
            <input type="number" step="0.01" min="0" name="items-{{ i }}-amount" class="form-control" placeholder="Amount"
                   value="{{ purchase_items[i]['amount'] if purchase_items|length > i else '' }}">
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  <button type="submit" name="addrow" value="1" class="btn btn-secondary mb-2">Add Row</button>

  <div class="row mb-3">
    <div class="col-md-3 text-end">
      <label class="form-label"><b>Discount%</b></label>
      <input type="number" step="0.01" min="0" max="100" name="discount_percent" id="discount_percent" class="form-control d-inline-block" style="width:140px"
             value="{{ discount_percent if discount_percent is defined else (purchase_discount_percent if purchase_discount_percent else '0') }}">
    </div>
    <!-- Header GST removed per request -->
    <div class="col text-end">
      <label for="grand_total" class="form-label"><b>Grand Total (Rs):</b></label>
      <input type="number" step="0.01" name="grand_total" id="grand_total" class="form-control d-inline-block" style="width:200px"
      value="{{ purchase_grand_total if purchase_grand_total else '' }}">
    </div>
  </div>

  <script>
  function validateForm() {
    const invoice = document.querySelector('[name="invoice_no"]').value.trim();
    const distributor = document.querySelector('[name="distributor_name"]').value.trim();
    const returnDate = document.querySelector('[name="return_date"]').value.trim();
    const grandTotal = document.querySelector('[name="grand_total"]').value.trim();
    if (!invoice) { alert('Invoice No. is required'); return false; }
    if (!distributor) { alert('Distributor name is required'); return false; }
    if (!returnDate) { alert('Return date is required'); return false; }
    if (!grandTotal) { alert('Grand total is required'); return false; }
    const rowcount = parseInt(document.querySelector('[name="rowcount"]').value || '0');
    let valid = false;
    for (let i=0;i<rowcount;i++){
      const prod = document.querySelector(`[name="items-${i}-product"]`).value.trim();
      const qty = document.querySelector(`[name="items-${i}-quantity"]`).value.trim();
      const rate = document.querySelector(`[name="items-${i}-rate"]`).value.trim();
      const expiry = document.querySelector(`[name="items-${i}-expiry_date"]`).value.trim();
      if (prod && qty && rate) {
        if (!expiry) { alert(`Row ${i+1}: Expiry date is required for entered product`); return false; }
        valid = true; break;
      }
    }
    if (!valid) { alert('At least one complete product row (product, qty, rate) with expiry date is required'); return false; }
    return true;
  }
  </script>
  <button type="submit" name="savepurchasereturn" value="1" class="btn btn-primary mb-2" onclick="return validateForm()">Save Purchase Return</button>
</form>

<datalist id="medicine_list">
  {% for med in medicines %}
  <option value="{{ med.name }}" label="{{ med.name }} ({{ med.batch_no }}, {{ med.expiry_date }})">
  {% endfor %}
</datalist>

<!-- Purchase Returns History Table -->
<h4>Purchase Returns History</h4>
<table class="table table-bordered table-striped text-center" id="purchase-returns-history-table">
  <thead>
    <tr>
      <th>Invoice ID</th>
      <th>Distributor Name</th>
      <th>Date</th>
      <th>No. of Items</th>
      <th>Amount Total</th>
      <th>Edit</th>
      <th>Print/View</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody>
    {% for ret in purchase_returns_history %}
    <tr>
      <td>{{ ret.invoice_no }}</td>
      <td>{{ ret.distributor_name or '' }}</td>
      <td>{{ ret.return_datetime }}</td>
      <td>{{ ret.item_count }}</td>
      <td>{{ "%.2f"|format(ret.total_amount) }}</td>
      <td>
        <form method="post" class="d-inline">
          <input type="hidden" name="startedit_purchasereturn_id" value="{{ ret.id }}">
          <button class="btn btn-sm btn-warning">Edit</button>
        </form>
      </td>
      <td>
        <a href="/purchase-return/{{ ret.id }}" class="btn btn-sm btn-primary">Print/View</a>
      </td>
      <td>
        <form method="post" class="d-inline" onsubmit="return confirm('Delete this purchase return?');">
          <input type="hidden" name="delpurchasereturn_id" value="{{ ret.id }}">
          <button class="btn btn-sm btn-danger">Delete</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="8" class="text-muted">No purchase returns yet.</td></tr>
    {% endfor %}
  </tbody>
</table>

<script src="{{ url_for('static', filename='js/autofill.js') }}"></script>
<script src="{{ url_for('static', filename='js/calculations.js') }}"></script>
<script src="{{ url_for('static', filename='js/ui-utils.js') }}"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    if (window.ui && window.ui.initializePage) {
        window.ui.initializePage(document.querySelector('form'));
    }
    // Expiry highlighting
    function highlightExpiryRows() {
        const expiryInputs = document.querySelectorAll('.expiry-date-input');
        const now = new Date();
        expiryInputs.forEach(input => {
            const tr = input.closest('tr');
            if (!input.value) { tr.classList.remove('expiry-near'); return; }
            const expiryDate = new Date(input.value);
            const diffDays = (expiryDate - now) / (1000*60*60*24);
            if (diffDays >=0 && diffDays <= 30) tr.classList.add('expiry-near'); else tr.classList.remove('expiry-near');
        });
    }
    highlightExpiryRows();
    document.querySelectorAll('.expiry-date-input').forEach(input => input.addEventListener('input', highlightExpiryRows));
    // When a per-row combined GST% is changed, split into SGST/CGST halves for calculation
    function bindRowGstSplit() {
      const rowcount = parseInt(document.querySelector('[name="rowcount"]').value || '0');
      for (let i=0;i<rowcount;i++) {
        const gstEl = document.querySelector(`[name="items-${i}-gst_percent"]`);
        if (!gstEl) continue;
        gstEl.addEventListener('input', function(){
          const v = parseFloat(gstEl.value);
          const half = (isNaN(v) ? 0 : v/2);
          const sEl = document.getElementById(`items-${i}-sgst_percent`);
          const cEl = document.getElementById(`items-${i}-cgst_percent`);
          if (sEl) sEl.value = half;
          if (cEl) cEl.value = half;
          // trigger recalculation for this row
          if (window.calc && typeof window.calc.calcRow === 'function') {
            window.calc.calcRow(i, document);
            window.calc.recalcAll(document);
          }
        });
        // initialize split on load
        try {
          const initV = parseFloat(gstEl.value);
          if (!isNaN(initV)) {
            const half = initV/2;
            const sEl = document.getElementById(`items-${i}-sgst_percent`);
            const cEl = document.getElementById(`items-${i}-cgst_percent`);
            if (sEl) sEl.value = half;
            if (cEl) cEl.value = half;
          }
        } catch(e){}
      }
    }
    bindRowGstSplit();

    // Auto-lock header fields (invoice, distributor, contact, date) so add/delete won't clear them.
    // User can still edit by focusing the field which will unlock it.
    (function lockHeaders(){
      const headers = ['invoice_no','distributor_name','distributor_contact','return_date'];
      headers.forEach(idOrName => {
        const el = document.querySelector(`[name="${idOrName}"]`) || document.getElementById(idOrName);
        if (!el) return;
        // don't lock if user already supplied a value via URL or editing state
        if (el.value && el.value.trim() !== '') {
          el.readOnly = true;
          el.dataset.locked = '1';
          // on focus, unlock so user can edit
          el.addEventListener('focus', function(){ el.readOnly = false; el.dataset.locked = '0'; });
        }
      });
    })();
});
</script>

{% endblock %}